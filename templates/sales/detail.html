{% extends "base.html" %}

{% block title %}{{ sale.sale_number }}{% endblock %}
{% block nav_sales %}active{% endblock %}

{% block page_title %}{{ sale.sale_number }}{% endblock %}
{% block page_sub_text %}{{ sale.sale_date|date:"j M Y" }}{% endblock %}

{% block extra_css %}
.detail-grid {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 20px;
    align-items: start;
}
.card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}
.card-head {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 8px;
}
.card-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px; font-weight: 700;
    color: var(--text-primary);
}
.card-body { padding: 20px; }

.info-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: 11px 0;
    border-bottom: 1px solid var(--border);
    font-size: 13px;
    gap: 12px;
}
.info-row:last-child { border-bottom: none; }
.info-label { color: var(--text-muted); font-size: 12px; white-space: nowrap; }
.info-value { color: var(--text-primary); font-weight: 500; text-align: right; }

/* ── Récapitulatif financier ── */
.cost-breakdown {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    margin-bottom: 16px;
}
.cost-item {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 12px 14px;
    text-align: center;
}
.cost-label { font-size: 10.5px; text-transform: uppercase; letter-spacing: .07em; color: var(--text-muted); margin-bottom: 6px; }
.cost-value { font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; color: var(--text-primary); }
.cost-sub { font-size: 10.5px; color: var(--text-muted); margin-top: 2px; }

/* ── Barre de marge ── */
.margin-bar {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: 14px 18px;
    margin-bottom: 16px;
    display: flex;
    align-items: center;
    gap: 16px;
}
.margin-track {
    flex: 1;
    height: 6px;
    background: var(--bg-hover);
    border-radius: 3px;
    overflow: hidden;
}
.margin-fill {
    height: 100%;
    border-radius: 3px;
    width: 0;
    background: #16a34a;
    transition: width .6s ease;
}
.margin-fill.negative { background: #dc2626; }

/* ── Boutons d'action ── */
.action-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    width: 100%;
    padding: 11px 16px;
    border-radius: var(--radius-md);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    transition: all var(--transition);
    border: none;
    text-decoration: none;
    justify-content: center;
    margin-bottom: 8px;
    min-height: 44px;
}
.action-primary { background: var(--accent); color: #ffffff; }
.action-primary:hover { opacity: .9; color: #ffffff; }
.action-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
}
.action-ghost:hover { background: var(--bg-hover); border-color: var(--border-strong); color: var(--text-primary); }
.action-danger {
    background: rgba(220,38,38,.10);
    border: 1px solid rgba(220,38,38,.25);
    color: #dc2626;
}
.action-danger:hover { background: rgba(220,38,38,.18); }

@media (max-width: 1024px) {
    .detail-grid { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
    .cost-breakdown { grid-template-columns: 1fr; }
}
{% endblock %}

{% block content %}

<!-- Retour + Barre d'actions -->
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px;">
    <a href="{% url 'sales:list' %}"
       style="display:inline-flex;align-items:center;gap:6px;font-size:13px;color:var(--text-secondary);transition:color var(--transition);"
       onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">
        <i class="bi bi-arrow-left"></i> Retour aux ventes
    </a>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
        {% if not sale.is_finalized %}
            {% if request.user.userprofile %}
                {% if request.user.userprofile.is_manager %}
                <a href="{% url 'sales:edit' sale.pk %}" class="btn-ghost" style="min-height:44px;">
                    <i class="bi bi-pencil"></i> Modifier
                </a>
                {% endif %}
            {% endif %}
        {% endif %}
        {% if not has_invoice %}
            {% if request.user.userprofile %}
                {% if request.user.userprofile.is_trader and sale.assigned_trader == request.user or request.user.userprofile.is_manager %}
                <a href="{% url 'sales:create_invoice' sale.pk %}" class="btn-primary" style="min-height:44px;">
                    <i class="bi bi-file-earmark-text"></i> Générer la facture
                </a>
                {% endif %}
            {% endif %}
        {% else %}
        <a href="{% url 'sales:invoice_detail' sale.invoice.pk %}" class="btn-ghost" style="min-height:44px;">
            <i class="bi bi-file-earmark-text"></i> Voir la facture
        </a>
        {% endif %}
    </div>
</div>

<div class="detail-grid">

    <!-- COLONNE GAUCHE -->
    <div>

        <!-- En-tête de la vente -->
        <div class="card">
            <div class="card-head">
                <div>
                    <div class="card-title">{{ sale.sale_number }}</div>
                    <div style="font-size:11.5px;color:var(--text-muted);margin-top:2px;">{{ sale.sale_date|date:"l j N Y" }}</div>
                </div>
                {% if sale.is_finalized %}
                <span class="pill pill-success"><i class="bi bi-check-circle"></i> Finalisé</span>
                {% else %}
                <span class="pill pill-warning"><i class="bi bi-clock"></i> Brouillon</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Véhicule</span>
                    <span class="info-value">
                        {{ sale.vehicle.make }} {{ sale.vehicle.model }} {{ sale.vehicle.year }}
                        <div style="font-size:11px;color:var(--text-muted);font-weight:400;">NIV : {{ sale.vehicle.vin_chassis|default:"—" }}</div>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Client</span>
                    <span class="info-value">
                        <a href="{% url 'customers:detail' sale.customer.pk %}" style="color:var(--accent);">{{ sale.customer.name }}</a>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Trader assigné</span>
                    <span class="info-value">{{ sale.assigned_trader.get_full_name|default:sale.assigned_trader.username }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Mode de paiement</span>
                    <span class="info-value"><span class="pill pill-neutral">{{ sale.get_payment_method_display }}</span></span>
                </div>
                {% if sale.notes %}
                <div class="info-row" style="align-items:flex-start;">
                    <span class="info-label">Notes</span>
                    <span class="info-value" style="font-size:12.5px;color:var(--text-secondary);font-weight:400;max-width:60%;">{{ sale.notes }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Analyse financière -->
        <div class="card">
            <div class="card-head">
                <div class="card-title"><i class="bi bi-piggy-bank me-2" style="color:#d97706;"></i>Analyse financière</div>
            </div>
            <div class="card-body">
                <div class="cost-breakdown">
                    <div class="cost-item">
                        <div class="cost-label">Coût d'achat</div>
                        <div class="cost-value">{{ sale.vehicle.landed_cost|floatformat:0 }}</div>
                        <div class="cost-sub">DA</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Prix de vente</div>
                        <div class="cost-value" style="color:var(--accent);">{{ sale.sale_price|floatformat:0 }}</div>
                        <div class="cost-sub">DA</div>
                    </div>
                    <div class="cost-item">
                        <div class="cost-label">Marge brute</div>
                        <div class="cost-value" style="color:{% if sale.margin_amount > 0 %}#16a34a{% else %}#dc2626{% endif %};">{{ sale.margin_amount|floatformat:0 }}</div>
                        <div class="cost-sub">DA</div>
                    </div>
                </div>

                <!-- Barre de marge -->
                <div class="margin-bar">
                    <div style="min-width:90px;">
                        <div style="font-size:10.5px;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);margin-bottom:3px;">Marge</div>
                        <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:18px;color:{% if sale.margin_amount > 0 %}#16a34a{% else %}#dc2626{% endif %};">
                            {{ margin_percentage|floatformat:1 }}%
                        </div>
                    </div>
                    <div class="margin-track">
                        <div class="margin-fill {% if sale.margin_amount < 0 %}negative{% endif %}" id="marginBar"></div>
                    </div>
                </div>

                <div class="info-row">
                    <span class="info-label">Taux de commission</span>
                    <span class="info-value">{{ sale.commission_rate|floatformat:1 }}%</span>
                </div>
                {% if sale.commission_amount %}
                <div class="info-row">
                    <span class="info-label">Montant de la commission</span>
                    <span class="info-value" style="color:#7c3aed;font-family:'Syne',sans-serif;font-weight:700;">{{ sale.commission_amount|floatformat:0 }} DA</span>
                </div>
                {% endif %}
                {% if sale.down_payment > 0 %}
                <div class="info-row">
                    <span class="info-label">Acompte versé</span>
                    <span class="info-value" style="color:#16a34a;">{{ sale.down_payment|floatformat:0 }} DA</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Solde restant</span>
                    <span class="info-value" style="color:#dc2626;">{{ sale.remaining_balance|floatformat:0 }} DA</span>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Facture associée -->
        {% if has_invoice %}
        <div class="card">
            <div class="card-head">
                <div class="card-title"><i class="bi bi-file-earmark-text me-2" style="color:#0284c7;"></i>Facture associée</div>
                {% if sale.invoice.status == 'paid' %}
                <span class="pill pill-success"><i class="bi bi-check-circle"></i> Payée</span>
                {% elif sale.invoice.status == 'cancelled' %}
                <span class="pill pill-danger">Annulée</span>
                {% elif sale.invoice.is_overdue %}
                <span class="pill pill-danger"><i class="bi bi-exclamation-circle"></i> En retard {{ sale.invoice.days_overdue }}j</span>
                {% else %}
                <span class="pill pill-warning">{{ sale.invoice.get_status_display }}</span>
                {% endif %}
            </div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">N° facture</span>
                    <span class="info-value">
                        <a href="{% url 'sales:invoice_detail' sale.invoice.pk %}" style="color:var(--accent);">{{ sale.invoice.invoice_number }}</a>
                    </span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date d'émission</span>
                    <span class="info-value">{{ sale.invoice.invoice_date|date:"j M Y" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Date d'échéance</span>
                    <span class="info-value" style="{% if sale.invoice.is_overdue %}color:#dc2626;{% endif %}">{{ sale.invoice.due_date|date:"j M Y" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Total TTC</span>
                    <span class="info-value" style="font-family:'Syne',sans-serif;font-weight:700;">{{ sale.invoice.total_ttc|floatformat:0 }} DA</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Montant payé</span>
                    <span class="info-value" style="color:#16a34a;">{{ sale.invoice.amount_paid|floatformat:0 }} DA</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Solde dû</span>
                    <span class="info-value" style="color:{% if sale.invoice.balance_due > 0 %}#dc2626{% else %}#16a34a{% endif %};">
                        {{ sale.invoice.balance_due|floatformat:0 }} DA
                    </span>
                </div>
                <div style="margin-top:14px;display:flex;gap:8px;">
                    <a href="{% url 'sales:invoice_detail' sale.invoice.pk %}" class="btn-ghost" style="flex:1;justify-content:center;min-height:44px;">
                        <i class="bi bi-eye"></i> Voir
                    </a>
                    <a href="{% url 'sales:invoice_print' sale.invoice.pk %}" class="btn-ghost" target="_blank" style="flex:1;justify-content:center;min-height:44px;">
                        <i class="bi bi-printer"></i> Imprimer
                    </a>
                </div>
            </div>
        </div>
        {% endif %}

    </div>

    <!-- COLONNE DROITE -->
    <div>

        <!-- Actions rapides -->
        <div class="card">
            <div class="card-head"><div class="card-title">Actions</div></div>
            <div class="card-body">
                {% if not sale.is_finalized %}
                    {% if request.user.userprofile %}
                        {% if request.user.userprofile.is_trader and sale.assigned_trader == request.user or request.user.userprofile.is_manager %}
                        <a href="{% url 'sales:edit' sale.pk %}" class="action-btn action-ghost">
                            <i class="bi bi-pencil"></i> Modifier la vente
                        </a>
                        <button class="action-btn action-primary" id="finalizeBtn" onclick="finaliserVente({{ sale.pk }})">
                            <i class="bi bi-lock"></i> Finaliser la vente
                        </button>
                        {% endif %}
                    {% endif %}
                {% endif %}

                {% if not has_invoice %}
                    {% if request.user.userprofile %}
                        {% if request.user.userprofile.is_trader and sale.assigned_trader == request.user or request.user.userprofile.is_manager %}
                        <a href="{% url 'sales:create_invoice' sale.pk %}" class="action-btn action-primary">
                            <i class="bi bi-file-earmark-plus"></i> Générer la facture
                        </a>
                        {% endif %}
                    {% endif %}
                {% else %}
                <a href="{% url 'sales:invoice_detail' sale.invoice.pk %}" class="action-btn action-ghost">
                    <i class="bi bi-file-earmark-text"></i> Voir la facture
                </a>
                <a href="{% url 'sales:invoice_print' sale.invoice.pk %}" class="action-btn action-ghost" target="_blank">
                    <i class="bi bi-printer"></i> Imprimer la facture
                </a>
                {% if sale.invoice.balance_due > 0 %}
                <a href="{% url 'payments:quick_payment' sale.invoice.pk %}" class="action-btn action-ghost">
                    <i class="bi bi-credit-card"></i> Enregistrer un paiement
                </a>
                {% endif %}
                {% endif %}
            </div>
        </div>

        <!-- Résumé véhicule -->
        <div class="card">
            <div class="card-head"><div class="card-title"><i class="bi bi-car-front-fill me-2" style="color:#0284c7;"></i>Véhicule</div></div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Marque / Modèle</span>
                    <span class="info-value">{{ sale.vehicle.make }} {{ sale.vehicle.model }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Année</span>
                    <span class="info-value">{{ sale.vehicle.year }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Couleur</span>
                    <span class="info-value">{{ sale.vehicle.color|default:"—" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">NIV / Châssis</span>
                    <span class="info-value" style="font-family:monospace;font-size:11px;">{{ sale.vehicle.vin_chassis|default:"—" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Statut</span>
                    <span class="info-value"><span class="pill pill-neutral">Vendu</span></span>
                </div>
                <a href="{% url 'inventory:detail' sale.vehicle.pk %}" class="action-btn action-ghost" style="margin-top:12px;margin-bottom:0;">
                    <i class="bi bi-boxes"></i> Voir dans l'inventaire
                </a>
            </div>
        </div>

        <!-- Résumé client -->
        <div class="card">
            <div class="card-head"><div class="card-title"><i class="bi bi-person me-2" style="color:#0d9488;"></i>Client</div></div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Nom</span>
                    <span class="info-value">{{ sale.customer.name }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Type</span>
                    <span class="info-value">{{ sale.customer.get_customer_type_display|default:"—" }}</span>
                </div>
                {% if sale.customer.phone %}
                <div class="info-row">
                    <span class="info-label">Téléphone</span>
                    <span class="info-value">{{ sale.customer.phone }}</span>
                </div>
                {% endif %}
                <a href="{% url 'customers:detail' sale.customer.pk %}" class="action-btn action-ghost" style="margin-top:12px;margin-bottom:0;">
                    <i class="bi bi-people"></i> Voir le client
                </a>
            </div>
        </div>

        <!-- Informations système -->
        <div class="card">
            <div class="card-head"><div class="card-title">Informations système</div></div>
            <div class="card-body">
                <div class="info-row">
                    <span class="info-label">Créé le</span>
                    <span class="info-value" style="font-size:12px;">{{ sale.created_at|date:"j M Y" }}</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Dernière mise à jour</span>
                    <span class="info-value" style="font-size:12px;">{{ sale.updated_at|date:"j M Y" }}</span>
                </div>
            </div>
        </div>

        <!-- Zone dangereuse -->
        {% if request.user.userprofile %}
            {% if request.user.userprofile.is_manager and not sale.is_finalized %}
            <div style="background:rgba(220,38,38,.07);border:1px solid rgba(220,38,38,.20);border-radius:var(--radius-md);padding:16px 18px;">
                <div style="font-family:'Syne',sans-serif;font-weight:700;color:#dc2626;margin-bottom:4px;">
                    <i class="bi bi-exclamation-triangle me-1"></i> Zone dangereuse
                </div>
                <p style="font-size:13px;color:var(--text-secondary);margin:0 0 12px;">
                    La suppression d'une vente est irréversible et entraînera la suppression de toutes les données associées.
                </p>
                <a href="{% url 'sales:delete' sale.pk %}" class="action-btn action-danger" style="margin-bottom:0;" onclick="return confirm('Supprimer définitivement cette vente ? Cette action est irréversible.')">
                    <i class="bi bi-trash"></i> Supprimer la vente
                </a>
            </div>
            {% endif %}
        {% endif %}

    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
/* Animation de la barre de marge */
window.addEventListener('DOMContentLoaded', () => {
    const bar = document.getElementById('marginBar');
    if (bar) {
        const pct = Math.min(Math.abs(parseFloat('{{ margin_percentage|floatformat:2 }}') || 0), 100);
        setTimeout(() => { bar.style.width = pct + '%'; }, 120);
    }
});

function finaliserVente(pk) {
    if (!confirm('Finaliser cette vente ? Cette action est irréversible.')) return;
    const btn = document.getElementById('finalizeBtn');
    if (btn) { btn.disabled = true; btn.innerHTML = '<span>Finalisation…</span>'; }
    fetch(`/sales/${pk}/finalize/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/json' }
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Erreur lors de la finalisation.');
            if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-lock"></i> Finaliser la vente'; }
        }
    })
    .catch(() => {
        alert('Erreur réseau. Veuillez réessayer.');
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="bi bi-lock"></i> Finaliser la vente'; }
    });
}
</script>
{% endblock %}