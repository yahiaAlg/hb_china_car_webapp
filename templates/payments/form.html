{% extends "base.html" %}

{% block title %}{% if payment %}Modifier le paiement{% else %}Nouveau paiement{% endif %}{% endblock %}
{% block nav_payments %}active{% endblock %}

{% block page_title %}{% if payment %}Modifier le paiement{% else %}Enregistrer un paiement{% endif %}{% endblock %}
{% block page_sub_text %}{% if payment %}{{ payment.payment_number }}{% else %}Saisie d'un nouveau r√®glement{% endif %}{% endblock %}

{% block extra_css %}
.form-layout {
    display: grid;
    grid-template-columns: 1fr 300px;
    gap: 20px;
    align-items: start;
    max-width: 980px;
}

.form-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.form-card-head {
    padding: 18px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--bg-raised);
}

.form-card-title {
    font-family: 'Syne', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--text-primary);
}

.form-card-body { padding: 22px 20px; }

.form-row { display: grid; gap: 14px; margin-bottom: 14px; }
.form-row.cols-2 { grid-template-columns: 1fr 1fr; }
.form-row.cols-3 { grid-template-columns: 1fr 1fr 1fr; }

.field-group { display: flex; flex-direction: column; gap: 6px; }

.field-label {
    font-size: 11px;
    font-weight: 600;
    letter-spacing: .06em;
    text-transform: uppercase;
    color: var(--text-secondary);
}

.field-label span.req { color: var(--accent); }

.field-input, .field-select, .field-textarea {
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 13.5px;
    padding: 11px 14px;
    width: 100%;
    min-height: 44px;
    transition: border-color .18s, box-shadow .18s;
}

.field-input:focus, .field-select:focus, .field-textarea:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
}

.field-textarea { resize: vertical; min-height: 90px; }
.field-select option { background: var(--bg-raised); }

.field-error {
    font-size: 11.5px;
    color: #dc2626;
    display: flex;
    align-items: center;
    gap: 4px;
}

/* Carte r√©sum√© de facture */
.invoice-summary-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    margin-bottom: 14px;
}

.invoice-summary-head {
    padding: 14px 16px;
    border-bottom: 1px solid var(--border);
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
    background: var(--bg-raised);
}

.invoice-summary-body { padding: 14px 16px; }

.summary-row {
    display: flex;
    justify-content: space-between;
    padding: 7px 0;
    border-bottom: 1px solid var(--border);
    font-size: 12.5px;
}

.summary-row:last-child { border-bottom: none; }
.summary-label { color: var(--text-muted); }
.summary-value { color: var(--text-secondary); font-weight: 500; }

.fade-in { animation: fadeIn .35s ease both; }

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
}

@media (max-width: 960px) {
    .form-layout { grid-template-columns: 1fr; }
    .form-row.cols-2 { grid-template-columns: 1fr; }
    .form-row.cols-3 { grid-template-columns: 1fr; }
}
{% endblock %}

{% block content %}

<!-- Retour -->
<div style="margin-bottom:20px;">
    <a href="{% url 'payments:list' %}" class="section-link" style="font-size:13px;color:var(--text-secondary);">
        <i class="bi bi-arrow-left me-1"></i> Retour aux paiements
    </a>
</div>

<div class="form-layout">

    <!-- Gauche : formulaire -->
    <div class="fade-in">
        <div class="form-card">
            <div class="form-card-head">
                <div style="width:40px;height:40px;background:var(--accent-dim);border-radius:var(--radius-sm);display:grid;place-items:center;color:var(--accent);font-size:18px;flex-shrink:0;">
                    <i class="bi bi-credit-card"></i>
                </div>
                <div>
                    <div class="form-card-title">{% if payment %}Modifier le paiement{% else %}Nouveau paiement{% endif %}</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:2px;">Remplissez tous les champs obligatoires</div>
                </div>
            </div>
            <div class="form-card-body">

                {% if form.non_field_errors %}
                <div style="background:rgba(220,38,38,.08);border:1px solid rgba(220,38,38,.20);border-radius:var(--radius-md);padding:12px 14px;margin-bottom:18px;">
                    <div style="font-size:13px;color:#dc2626;display:flex;align-items:center;gap:6px;">
                        <i class="bi bi-exclamation-triangle"></i>
                        {% for error in form.non_field_errors %}{{ error }}{% endfor %}
                    </div>
                </div>
                {% endif %}

                <form method="post" id="paymentForm">
                    {% csrf_token %}

                    <!-- Facture -->
                    <div class="form-row">
                        <div class="field-group">
                            <label class="field-label">Facture <span class="req">*</span></label>
                            <select name="{{ form.invoice.html_name }}"
                                class="field-select {% if form.invoice.errors %}is-invalid{% endif %}"
                                id="invoiceSelect">
                                <option value="">‚Äî S√©lectionner une facture ‚Äî</option>
                                {% for inv in form.invoice.field.queryset %}
                                <option value="{{ inv.pk }}"
                                    data-total="{{ inv.total_ttc|floatformat:0 }}"
                                    data-paid="{{ inv.amount_paid|floatformat:0 }}"
                                    data-balance="{{ inv.balance_due|floatformat:2 }}"
                                    data-customer="{{ inv.customer.name|default:'' }}"
                                    {% if form.invoice.value == inv.pk|stringformat:"s" %}selected{% endif %}>
                                    {{ inv.invoice_number }} ‚Äî {{ inv.customer.name|default:"?" }} ({{ inv.balance_due|floatformat:0 }} DA restant)
                                </option>
                                {% endfor %}
                            </select>
                            {% if form.invoice.errors %}
                            <div class="field-error"><i class="bi bi-exclamation-circle"></i>{{ form.invoice.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Montant + Date -->
                    <div class="form-row cols-2">
                        <div class="field-group">
                            <label class="field-label">Montant (DA) <span class="req">*</span></label>
                            <input type="number"
                                name="{{ form.amount.html_name }}"
                                value="{{ form.amount.value|default_if_none:'' }}"
                                id="amountInput"
                                step="0.01" min="0.01"
                                class="field-input {% if form.amount.errors %}is-invalid{% endif %}"
                                placeholder="0,00">
                            {% if form.amount.errors %}
                            <div class="field-error"><i class="bi bi-exclamation-circle"></i>{{ form.amount.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field-group">
                            <label class="field-label">Date du paiement <span class="req">*</span></label>
                            <input type="date"
                                name="{{ form.payment_date.html_name }}"
                                value="{{ form.payment_date.value|date:'Y-m-d'|default_if_none:'' }}"
                                class="field-input {% if form.payment_date.errors %}is-invalid{% endif %}">
                            {% if form.payment_date.errors %}
                            <div class="field-error"><i class="bi bi-exclamation-circle"></i>{{ form.payment_date.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- M√©thode + R√©f√©rence -->
                    <div class="form-row cols-2">
                        <div class="field-group">
                            <label class="field-label">M√©thode de paiement <span class="req">*</span></label>
                            <select name="{{ form.payment_method.html_name }}"
                                class="field-select {% if form.payment_method.errors %}is-invalid{% endif %}">
                                <option value="">‚Äî S√©lectionner ‚Äî</option>
                                <option value="cash" {% if form.payment_method.value == 'cash' %}selected{% endif %}>üíµ Esp√®ces</option>
                                <option value="bank_transfer" {% if form.payment_method.value == 'bank_transfer' %}selected{% endif %}>üè¶ Virement bancaire</option>
                                <option value="check" {% if form.payment_method.value == 'check' %}selected{% endif %}>üìÑ Ch√®que</option>
                                <option value="card" {% if form.payment_method.value == 'card' %}selected{% endif %}>üí≥ Carte</option>
                                <option value="other" {% if form.payment_method.value == 'other' %}selected{% endif %}>Autre</option>
                            </select>
                            {% if form.payment_method.errors %}
                            <div class="field-error"><i class="bi bi-exclamation-circle"></i>{{ form.payment_method.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="field-group">
                            <label class="field-label">R√©f√©rence bancaire / ch√®que</label>
                            <input type="text"
                                name="{{ form.bank_reference.html_name }}"
                                value="{{ form.bank_reference.value|default_if_none:'' }}"
                                class="field-input {% if form.bank_reference.errors %}is-invalid{% endif %}"
                                placeholder="N¬∞ de r√©f√©rence‚Ä¶">
                            {% if form.bank_reference.errors %}
                            <div class="field-error"><i class="bi bi-exclamation-circle"></i>{{ form.bank_reference.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Notes -->
                    <div class="form-row" style="margin-bottom:0;">
                        <div class="field-group">
                            <label class="field-label">Notes internes</label>
                            <textarea name="{{ form.notes.html_name }}"
                                class="field-textarea {% if form.notes.errors %}is-invalid{% endif %}"
                                placeholder="Observations, commentaires‚Ä¶">{{ form.notes.value|default_if_none:'' }}</textarea>
                            {% if form.notes.errors %}
                            <div class="field-error"><i class="bi bi-exclamation-circle"></i>{{ form.notes.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>

                    <div style="display:flex;gap:10px;margin-top:22px;padding-top:18px;border-top:1px solid var(--border);">
                        <button type="submit" class="btn-primary" style="flex:1;padding:12px;font-size:14px;display:flex;align-items:center;justify-content:center;gap:8px;min-height:44px;">
                            <i class="bi bi-check-circle"></i>
                            {% if payment %}Enregistrer les modifications{% else %}Valider le paiement{% endif %}
                        </button>
                        <a href="{% url 'payments:list' %}" class="btn-ghost" style="padding:12px 18px;font-size:14px;display:inline-flex;align-items:center;gap:6px;min-height:44px;">
                            <i class="bi bi-x-lg"></i> Annuler
                        </a>
                    </div>
                </form>

            </div>
        </div>
    </div>

    <!-- Droite : r√©sum√© de la facture -->
    <div class="fade-in" style="animation-delay:60ms;">

        <!-- R√©sum√© dynamique -->
        <div class="invoice-summary-card" id="invoiceSummaryCard" style="{% if not form.invoice.value %}display:none;{% endif %}">
            <div class="invoice-summary-head">
                <i class="bi bi-receipt" style="color:var(--accent);"></i>
                R√©sum√© de la facture
            </div>
            <div class="invoice-summary-body">
                <div style="background:linear-gradient(135deg,rgba(217,119,6,.10),rgba(217,119,6,.03));border:1px solid rgba(217,119,6,.20);border-radius:var(--radius-md);padding:14px;text-align:center;margin-bottom:12px;">
                    <div style="font-size:10px;letter-spacing:.08em;text-transform:uppercase;color:var(--text-muted);font-weight:600;margin-bottom:4px;">Solde restant</div>
                    <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent);" id="summaryBalance">‚Äî</div>
                    <div style="font-size:11px;color:var(--text-muted);">DA</div>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Client</span>
                    <span class="summary-value" id="summaryCustomer">‚Äî</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">Total facture</span>
                    <span class="summary-value" id="summaryTotal">‚Äî</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">D√©j√† pay√©</span>
                    <span class="summary-value" style="color:#16a34a;font-weight:600;" id="summaryPaid">‚Äî</span>
                </div>
            </div>
        </div>

        <!-- Aide contextuelle -->
        <div style="background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px;box-shadow:var(--shadow-sm);">
            <div style="font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);font-weight:600;margin-bottom:10px;">
                Conseils
            </div>
            <ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">
                <li style="display:flex;gap:8px;font-size:12.5px;color:var(--text-secondary);">
                    <i class="bi bi-info-circle" style="color:var(--accent);flex-shrink:0;margin-top:1px;"></i>
                    S√©lectionnez d'abord la facture pour voir le solde restant.
                </li>
                <li style="display:flex;gap:8px;font-size:12.5px;color:var(--text-secondary);">
                    <i class="bi bi-info-circle" style="color:var(--accent);flex-shrink:0;margin-top:1px;"></i>
                    Le montant ne peut pas d√©passer le solde d√ª.
                </li>
                <li style="display:flex;gap:8px;font-size:12.5px;color:var(--text-secondary);">
                    <i class="bi bi-info-circle" style="color:var(--accent);flex-shrink:0;margin-top:1px;"></i>
                    Ajoutez la r√©f√©rence ch√®que/virement pour la tra√ßabilit√©.
                </li>
            </ul>
        </div>

    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
const invoiceSelect = document.getElementById('invoiceSelect');
const summaryCard   = document.getElementById('invoiceSummaryCard');

function updateSummary() {
    const opt = invoiceSelect.options[invoiceSelect.selectedIndex];
    if (!opt || !opt.value) {
        summaryCard.style.display = 'none';
        return;
    }
    summaryCard.style.display = '';
    document.getElementById('summaryBalance').textContent  = parseInt(opt.dataset.balance  || 0).toLocaleString('fr-FR') || '‚Äî';
    document.getElementById('summaryTotal').textContent    = parseInt(opt.dataset.total    || 0).toLocaleString('fr-FR') + ' DA';
    document.getElementById('summaryPaid').textContent     = parseInt(opt.dataset.paid     || 0).toLocaleString('fr-FR') + ' DA';
    document.getElementById('summaryCustomer').textContent = opt.dataset.customer || '‚Äî';
    // Pr√©-remplir le montant avec le solde
    const amountInput = document.getElementById('amountInput');
    if (!amountInput.value) {
        amountInput.value = parseFloat(opt.dataset.balance || 0).toFixed(2);
    }
}

invoiceSelect.addEventListener('change', updateSummary);
updateSummary(); // Au chargement si d√©j√† s√©lectionn√©e

// Pr√©-remplir la date avec aujourd'hui si vide
const dateInput = document.querySelector('input[name*="payment_date"]');
if (dateInput && !dateInput.value) {
    dateInput.value = new Date().toISOString().slice(0, 10);
}
</script>
{% endblock %}