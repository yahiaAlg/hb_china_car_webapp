{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}
{% block nav_settings %}active{% endblock %}

{% block page_title %}{{ title }}{% endblock %}
{% block page_sub_text %}Record a currency exchange rate{% endblock %}

{% block extra_css %}
.back-link { display:inline-flex;align-items:center;gap:6px;font-size:12.5px;color:var(--text-muted);margin-bottom:20px;text-decoration:none;transition:color var(--transition); }
.back-link:hover { color:var(--accent); }

.form-layout { display:grid; grid-template-columns:1fr 300px; gap:20px; align-items:start; }
@media (max-width:900px) { .form-layout { grid-template-columns:1fr; } }

.form-card { background:var(--bg-surface); border:1px solid var(--border); border-radius:var(--radius-lg); overflow:hidden; }
.form-card-head { padding:16px 20px; border-bottom:1px solid var(--border); }
.form-card-title { font-family:'Syne',sans-serif; font-size:14px; font-weight:700; color:var(--text-primary); }
.form-card-body { padding:20px; }

.section-label { font-size:10.5px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px;margin-top:4px; }
.field { margin-bottom:16px; }
.field label { font-size:11px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted);display:block;margin-bottom:7px; }
.field-required::after { content:' *';color:var(--accent); }

.form-control { width:100%;background:var(--bg-raised);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:'DM Sans',sans-serif;font-size:14px;padding:11px 13px;outline:none;appearance:none;transition:border-color var(--transition),box-shadow var(--transition); }
.form-control:focus { border-color:var(--accent);box-shadow:0 0 0 3px rgba(240,165,0,.15); }
.form-control::placeholder { color:var(--text-muted); }
textarea.form-control { resize:vertical;min-height:80px; }

.field-group { display:grid;grid-template-columns:1fr 1fr;gap:14px; }
@media (max-width:640px) { .field-group { grid-template-columns:1fr; } }

.form-error { font-size:11.5px;color:#f87171;margin-top:5px;display:flex;align-items:center;gap:4px; }

.preview-box { background:var(--bg-raised); border:1px solid rgba(240,165,0,.25); border-radius:var(--radius-md); padding:14px 16px; margin-bottom:0; text-align:center; }
.preview-eq { font-size:12px;color:var(--text-muted);margin-bottom:4px; }
.preview-val { font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent); }

.submit-row { display:flex;align-items:center;gap:10px;padding-top:8px; }
.btn-primary-x { display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#0d0f12;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border-radius:var(--radius-md);padding:11px 22px;border:none;cursor:pointer;transition:opacity .18s,transform .12s; }
.btn-primary-x:hover { opacity:.88; }
.btn-ghost-x { display:inline-flex;align-items:center;gap:8px;background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:'Syne',sans-serif;font-weight:600;font-size:14px;border-radius:var(--radius-md);padding:11px 20px;text-decoration:none;transition:all var(--transition); }
.btn-ghost-x:hover { background:var(--bg-hover);border-color:var(--border-strong);color:var(--text-primary); }

.sidebar-card { background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px 20px;margin-bottom:16px; }
.sidebar-card-title { font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px;display:flex;align-items:center;gap:8px; }
.info-row { display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border);font-size:12.5px; }
.info-row:last-child { border-bottom:none; }

.fade-in { animation:fadeIn .35s ease both; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
{% endblock %}

{% block content %}

<a href="{% url 'system_settings:exchange_rates' %}" class="back-link fade-in">
    <i class="bi bi-arrow-left"></i> Back to Exchange Rates
</a>

<div class="form-layout fade-in">

    <div>
        <form method="post">
            {% csrf_token %}

            {% if form.non_field_errors %}
            <div style="background:rgba(239,68,68,.1);border:1px solid rgba(239,68,68,.25);border-radius:var(--radius-md);padding:12px 14px;margin-bottom:18px;font-size:13px;color:#f87171;">
                <i class="bi bi-exclamation-circle me-2"></i>{% for e in form.non_field_errors %}{{ e }}{% endfor %}
            </div>
            {% endif %}

            <div class="form-card">
                <div class="form-card-head">
                    <div class="form-card-title"><i class="bi bi-currency-dollar me-2" style="color:#7dd3fc;"></i>{{ title }}</div>
                </div>
                <div class="form-card-body">

                    <div class="section-label">Currency Pair</div>
                    <div class="field-group">
                        <div class="field">
                            <label class="field-required">From Currency</label>
                            <select name="from_currency" id="fromCur" class="form-control" style="cursor:pointer;" oninput="updatePreview()">
                                <option value="">— Select —</option>
                                {% for cur in form.from_currency.field.queryset %}
                                <option value="{{ cur.pk }}" data-code="{{ cur.code }}" {% if form.from_currency.value|stringformat:"s" == cur.pk|stringformat:"s" %}selected{% endif %}>{{ cur.code }} — {{ cur.name }}</option>
                                {% endfor %}
                            </select>
                            {% for e in form.from_currency.errors %}<div class="form-error"><i class="bi bi-exclamation-circle"></i> {{ e }}</div>{% endfor %}
                        </div>
                        <div class="field">
                            <label class="field-required">To Currency</label>
                            <select name="to_currency" id="toCur" class="form-control" style="cursor:pointer;" oninput="updatePreview()">
                                <option value="">— Select —</option>
                                {% for cur in form.to_currency.field.queryset %}
                                <option value="{{ cur.pk }}" data-code="{{ cur.code }}" {% if form.to_currency.value|stringformat:"s" == cur.pk|stringformat:"s" %}selected{% endif %}>{{ cur.code }} — {{ cur.name }}</option>
                                {% endfor %}
                            </select>
                            {% for e in form.to_currency.errors %}<div class="form-error"><i class="bi bi-exclamation-circle"></i> {{ e }}</div>{% endfor %}
                        </div>
                    </div>

                    <div style="height:1px;background:var(--border);margin:4px 0 20px;"></div>
                    <div class="section-label">Rate &amp; Date</div>

                    <div class="field-group">
                        <div class="field">
                            <label class="field-required">Exchange Rate</label>
                            <input type="number" name="rate" id="rateInput" value="{{ form.rate.value|default:'' }}" step="0.000001" min="0" placeholder="0.000000" class="form-control" oninput="updatePreview()">
                            {% for e in form.rate.errors %}<div class="form-error"><i class="bi bi-exclamation-circle"></i> {{ e }}</div>{% endfor %}
                        </div>
                        <div class="field">
                            <label class="field-required">Effective Date</label>
                            <input type="date" name="effective_date" value="{{ form.effective_date.value|default:'' }}" class="form-control">
                            {% for e in form.effective_date.errors %}<div class="form-error"><i class="bi bi-exclamation-circle"></i> {{ e }}</div>{% endfor %}
                        </div>
                    </div>

                    <!-- Live preview -->
                    <div class="preview-box" style="margin-bottom:20px;">
                        <div class="preview-eq" id="previewEq">Select currencies and enter rate</div>
                        <div class="preview-val" id="previewVal">—</div>
                    </div>

                    <div style="height:1px;background:var(--border);margin:4px 0 20px;"></div>
                    <div class="section-label">Additional Info</div>

                    <div class="field">
                        <label>Source</label>
                        <input type="text" name="source" value="{{ form.source.value|default:'' }}" placeholder="e.g. Banque d'Algérie, manual entry…" class="form-control">
                    </div>
                    <div class="field" style="margin-bottom:0;">
                        <label>Notes</label>
                        <textarea name="notes" class="form-control" rows="3" placeholder="Any notes…">{{ form.notes.value|default:'' }}</textarea>
                    </div>
                </div>
            </div>

            <div class="submit-row">
                <button type="submit" class="btn-primary-x"><i class="bi bi-check-lg"></i> Save Rate</button>
                <a href="{% url 'system_settings:exchange_rates' %}" class="btn-ghost-x">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div>
        <div class="sidebar-card" style="border-left:2px solid var(--accent);">
            <div class="sidebar-card-title"><i class="bi bi-info-circle" style="color:var(--accent);"></i>Usage</div>
            <p style="font-size:12.5px;color:var(--text-secondary);line-height:1.6;margin:0 0 10px;">
                Exchange rates are used to automatically calculate DA prices when recording vehicle purchases. The <strong style="color:var(--text-primary);">most recent rate</strong> for each pair is applied as the default.
            </p>
            <p style="font-size:12.5px;color:var(--text-secondary);line-height:1.6;margin:0;">
                Track historical rates to audit past transactions accurately.
            </p>
        </div>

        {% if rate %}
        <div class="sidebar-card">
            <div class="sidebar-card-title"><i class="bi bi-clock-history" style="color:#a5b4fc;"></i>Current Record</div>
            <div class="info-row">
                <span style="color:var(--text-muted);">Pair</span>
                <span style="font-weight:600;color:var(--text-primary);">{{ rate.from_currency.code }} → {{ rate.to_currency.code }}</span>
            </div>
            <div class="info-row">
                <span style="color:var(--text-muted);">Rate</span>
                <span style="font-family:'Syne',sans-serif;font-weight:700;color:var(--accent);">{{ rate.rate|floatformat:6 }}</span>
            </div>
            <div class="info-row">
                <span style="color:var(--text-muted);">Effective</span>
                <span style="color:var(--text-primary);">{{ rate.effective_date|date:"M j, Y" }}</span>
            </div>
        </div>
        {% endif %}
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
function updatePreview() {
    const fromSel = document.getElementById('fromCur');
    const toSel   = document.getElementById('toCur');
    const rateIn  = document.getElementById('rateInput');
    const eqEl    = document.getElementById('previewEq');
    const valEl   = document.getElementById('previewVal');

    const fromCode = fromSel.options[fromSel.selectedIndex]?.dataset?.code || '?';
    const toCode   = toSel.options[toSel.selectedIndex]?.dataset?.code   || '?';
    const rate     = parseFloat(rateIn.value) || 0;

    eqEl.textContent = `1 ${fromCode} =`;
    valEl.textContent = rate > 0 ? rate.toFixed(4) + ' ' + toCode : '—';
}
document.addEventListener('DOMContentLoaded', updatePreview);
</script>
{% endblock %}