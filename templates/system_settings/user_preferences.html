{% extends "base.html" %}

{% block title %}User Preferences{% endblock %}
{% block nav_settings %}active{% endblock %}

{% block page_title %}User Preferences{% endblock %}
{% block page_sub_text %}Your personal display and notification settings{% endblock %}

{% block extra_css %}
.back-link { display:inline-flex;align-items:center;gap:6px;font-size:12.5px;color:var(--text-muted);margin-bottom:20px;text-decoration:none;transition:color var(--transition); }
.back-link:hover { color:var(--accent); }

.pref-layout { display:grid;grid-template-columns:1fr 280px;gap:20px;align-items:start; }
@media (max-width:900px) { .pref-layout { grid-template-columns:1fr; } }

.form-card { background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;margin-bottom:20px; }
.form-card-head { padding:16px 20px;border-bottom:1px solid var(--border); }
.form-card-title { font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary); }
.form-card-body { padding:20px; }

.section-label { font-size:10.5px;font-weight:600;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px;margin-top:4px; }
.field { margin-bottom:16px; }
.field label { font-size:11px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--text-muted);display:block;margin-bottom:7px; }

.form-control { width:100%;background:var(--bg-raised);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:'DM Sans',sans-serif;font-size:14px;padding:11px 13px;outline:none;appearance:none;transition:border-color var(--transition),box-shadow var(--transition); }
.form-control:focus { border-color:var(--accent);box-shadow:0 0 0 3px rgba(240,165,0,.15); }

.field-group { display:grid;grid-template-columns:1fr 1fr;gap:14px; }
@media (max-width:640px) { .field-group { grid-template-columns:1fr; } }

/* Toggle rows */
.toggle-field { display:flex;align-items:center;justify-content:space-between;padding:12px 14px;background:var(--bg-raised);border:1px solid var(--border);border-radius:var(--radius-md);cursor:pointer;margin-bottom:10px;transition:border-color var(--transition); }
.toggle-field:hover { border-color:var(--border-strong); }
.toggle-label-text { font-size:13px;color:var(--text-secondary);display:flex;align-items:center;gap:8px; }
.toggle-switch { position:relative;width:40px;height:22px;flex-shrink:0; }
.toggle-switch input { opacity:0;width:0;height:0; }
.toggle-track { position:absolute;inset:0;background:var(--bg-hover);border-radius:11px;transition:background var(--transition);cursor:pointer; }
.toggle-track::before { content:'';position:absolute;left:3px;top:3px;width:16px;height:16px;border-radius:50%;background:var(--text-muted);transition:transform var(--transition),background var(--transition); }
.toggle-switch input:checked + .toggle-track { background:var(--accent-dim);border:1px solid var(--accent); }
.toggle-switch input:checked + .toggle-track::before { transform:translateX(18px);background:var(--accent); }

/* Format selector */
.format-grid { display:grid;grid-template-columns:repeat(3,1fr);gap:8px; }
.format-opt { padding:12px 8px;border:1px solid var(--border);border-radius:var(--radius-md);text-align:center;cursor:pointer;transition:all var(--transition); }
.format-opt:hover { border-color:var(--border-strong);background:var(--bg-hover); }
.format-opt.selected { border-color:var(--accent);background:var(--accent-dim); }
.format-opt i { font-size:18px;display:block;margin-bottom:5px; }
.format-opt-label { font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--text-primary); }

.submit-row { display:flex;align-items:center;gap:10px;padding-top:4px; }
.btn-primary-x { display:inline-flex;align-items:center;gap:8px;background:var(--accent);color:#0d0f12;font-family:'Syne',sans-serif;font-weight:700;font-size:14px;border-radius:var(--radius-md);padding:11px 22px;border:none;cursor:pointer;transition:opacity .18s; }
.btn-primary-x:hover { opacity:.88; }
.btn-ghost-x { display:inline-flex;align-items:center;gap:8px;background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:'Syne',sans-serif;font-weight:600;font-size:14px;border-radius:var(--radius-md);padding:11px 20px;text-decoration:none;transition:all var(--transition); }
.btn-ghost-x:hover { background:var(--bg-hover);border-color:var(--border-strong);color:var(--text-primary); }

.sidebar-card { background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:18px 20px;margin-bottom:16px; }
.sidebar-card-title { font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--text-primary);margin-bottom:12px;display:flex;align-items:center;gap:8px; }

.avatar-large { width:64px;height:64px;border-radius:50%;background:var(--accent-dim);border:2px solid var(--accent);display:grid;place-items:center;font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent);margin:0 auto 12px; }

.fade-in { animation:fadeIn .35s ease both; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
{% endblock %}

{% block content %}

<a href="{% url 'system_settings:system_status' %}" class="back-link fade-in">
    <i class="bi bi-arrow-left"></i> Back to Settings
</a>

<div class="pref-layout fade-in">

    <div>
        <form method="post">
            {% csrf_token %}

            <!-- Display -->
            <div class="form-card">
                <div class="form-card-head">
                    <div class="form-card-title"><i class="bi bi-display me-2" style="color:#a5b4fc;"></i>Display</div>
                </div>
                <div class="form-card-body">
                    <div class="field-group" style="margin-bottom:16px;">
                        <div class="field">
                            <label>Theme</label>
                            <select name="theme" class="form-control" style="cursor:pointer;">
                                {% for val, label in form.theme.field.choices %}
                                <option value="{{ val }}" {% if form.theme.value == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="field">
                            <label>Language</label>
                            <select name="language" class="form-control" style="cursor:pointer;">
                                {% for val, label in form.language.field.choices %}
                                <option value="{{ val }}" {% if form.language.value == val %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="field" style="margin-bottom:0;">
                        <label>Items per Page</label>
                        <select name="default_page_size" class="form-control" style="cursor:pointer;max-width:200px;">
                            {% for val, label in form.default_page_size.field.choices %}
                            <option value="{{ val }}" {% if form.default_page_size.value|stringformat:"s" == val|stringformat:"s" %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <!-- Notifications -->
            <div class="form-card">
                <div class="form-card-head">
                    <div class="form-card-title"><i class="bi bi-bell me-2" style="color:#4ade80;"></i>Notifications</div>
                </div>
                <div class="form-card-body">
                    <label class="toggle-field" for="id_email_notif">
                        <span class="toggle-label-text"><i class="bi bi-envelope" style="color:var(--text-muted);"></i> Email notifications</span>
                        <div class="toggle-switch">
                            <input type="checkbox" name="email_notifications" id="id_email_notif" {% if form.email_notifications.value %}checked{% endif %}>
                            <div class="toggle-track"></div>
                        </div>
                    </label>
                    <label class="toggle-field" for="id_browser_notif" style="margin-bottom:0;">
                        <span class="toggle-label-text"><i class="bi bi-browser-safari" style="color:var(--text-muted);"></i> Browser notifications</span>
                        <div class="toggle-switch">
                            <input type="checkbox" name="browser_notifications" id="id_browser_notif" {% if form.browser_notifications.value %}checked{% endif %}>
                            <div class="toggle-track"></div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Export format -->
            <div class="form-card">
                <div class="form-card-head">
                    <div class="form-card-title"><i class="bi bi-download me-2" style="color:#fb923c;"></i>Default Export Format</div>
                </div>
                <div class="form-card-body">
                    <input type="hidden" name="default_export_format" id="exportFormatInput" value="{{ form.default_export_format.value|default:'excel' }}">
                    <div class="format-grid">
                        <div class="format-opt {% if form.default_export_format.value == 'excel' or not form.default_export_format.value %}selected{% endif %}" onclick="selectFormat('excel', this)">
                            <i class="bi bi-file-earmark-excel" style="color:#4ade80;"></i>
                            <div class="format-opt-label">Excel</div>
                        </div>
                        <div class="format-opt {% if form.default_export_format.value == 'csv' %}selected{% endif %}" onclick="selectFormat('csv', this)">
                            <i class="bi bi-filetype-csv" style="color:#7dd3fc;"></i>
                            <div class="format-opt-label">CSV</div>
                        </div>
                        <div class="format-opt {% if form.default_export_format.value == 'pdf' %}selected{% endif %}" onclick="selectFormat('pdf', this)">
                            <i class="bi bi-file-earmark-pdf" style="color:#f87171;"></i>
                            <div class="format-opt-label">PDF</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="submit-row">
                <button type="submit" class="btn-primary-x"><i class="bi bi-check-lg"></i> Save Preferences</button>
                <a href="{% url 'system_settings:system_status' %}" class="btn-ghost-x">Cancel</a>
            </div>
        </form>
    </div>

    <!-- Sidebar -->
    <div>
        <div class="sidebar-card" style="text-align:center;">
            <div class="avatar-large">
                {{ request.user.get_full_name|slice:":1"|default:request.user.username|slice:":1"|upper }}
            </div>
            <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text-primary);">
                {{ request.user.get_full_name|default:request.user.username }}
            </div>
            <div style="font-size:12px;color:var(--text-muted);margin-top:3px;">{{ request.user.email|default:"No email set" }}</div>
            {% if request.user.userprofile %}
            <div style="margin-top:10px;">
                <span style="display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;background:var(--accent-dim);color:var(--accent);">
                    <i class="bi bi-shield-check"></i> {{ request.user.userprofile.get_role_display }}
                </span>
            </div>
            {% endif %}
        </div>

        <div class="sidebar-card" style="background:rgba(56,189,248,.05);border-color:rgba(56,189,248,.15);">
            <div class="sidebar-card-title" style="color:#7dd3fc;"><i class="bi bi-info-circle"></i> Note on Theme</div>
            <p style="font-size:12.5px;color:var(--text-secondary);line-height:1.6;margin:0;">
                The application currently uses the <strong style="color:var(--text-primary);">Industrial Dark</strong> theme system-wide. Theme preferences are saved for future feature availability.
            </p>
        </div>
    </div>

</div>

{% endblock %}

{% block extra_js %}
<script>
function selectFormat(value, el) {
    document.getElementById('exportFormatInput').value = value;
    document.querySelectorAll('.format-opt').forEach(o => o.classList.remove('selected'));
    el.classList.add('selected');
}
</script>
{% endblock %}