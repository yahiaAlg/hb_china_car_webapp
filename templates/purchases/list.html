{% extends "base.html" %}

{% block title %}Achats{% endblock %}
{% block nav_purchases %}active{% endblock %}

{% block page_title %}Achats{% endblock %}
{% block page_sub_text %}{{ total_count }} commande{{ total_count|pluralize }}{% endblock %}

{% block extra_css %}
/* ── En-tête de page ── */
.page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 12px;
}

/* ── Carte de filtres ── */
.filter-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 16px 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow-sm);
}

.filter-row {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
    gap: 10px;
    align-items: end;
}

@media (max-width: 1100px) { .filter-row { grid-template-columns: 1fr 1fr 1fr; } }
@media (max-width: 700px)  { .filter-row { grid-template-columns: 1fr; } }

.filter-group label {
    font-size: 10.5px;
    font-weight: 600;
    letter-spacing: .07em;
    text-transform: uppercase;
    color: var(--text-muted);
    display: block;
    margin-bottom: 6px;
}

.filter-input {
    width: 100%;
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 13.5px;
    padding: 10px 12px;
    outline: none;
    transition: border-color var(--transition);
    min-height: 44px;
    appearance: none;
}
.filter-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
.filter-input-icon { padding-left: 36px; }

.filter-input-wrap { position: relative; }
.filter-input-wrap i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-muted);
    font-size: 13px;
    pointer-events: none;
}

/* ── Carte de tableau ── */
.table-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
}

.table-card-head {
    padding: 16px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 10px;
    background: var(--bg-surface);
}

.table-scroll { overflow-x: auto; }

.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead th {
    padding: 13px 14px;
    font-size: 10.5px;
    font-weight: 600;
    letter-spacing: .07em;
    text-transform: uppercase;
    color: var(--text-muted);
    border-bottom: 1px solid var(--border);
    background: var(--bg-raised);
    white-space: nowrap;
}

.data-table tbody td {
    padding: 13px 14px;
    font-size: 13px;
    color: var(--text-secondary);
    border-bottom: 1px solid var(--border);
    vertical-align: middle;
}

.data-table tbody tr:last-child td { border-bottom: none; }
.data-table tbody tr {
    cursor: pointer;
    transition: background var(--transition);
}
.data-table tbody tr:hover { background: var(--bg-hover); }

/* ── Badges ── */
.pill {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 9px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 500;
    white-space: nowrap;
}
.pill-success { background: rgba(22,163,74,.10);  color: #16a34a; }
.pill-warning { background: rgba(217,119,6,.12);  color: #d97706; }
.pill-info    { background: rgba(2,132,199,.10);  color: #0284c7; }
.pill-neutral { background: var(--bg-hover);      color: var(--text-secondary); }
.pill-danger  { background: rgba(220,38,38,.10);  color: #dc2626; }

/* ── Pagination ── */
.pagination-bar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-top: 1px solid var(--border);
    font-size: 12.5px;
    color: var(--text-muted);
    flex-wrap: wrap;
    gap: 10px;
}

.page-btns { display: flex; gap: 4px; }

.page-btn {
    width: 32px;
    height: 32px;
    display: grid;
    place-items: center;
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    background: transparent;
    color: var(--text-secondary);
    font-size: 12.5px;
    cursor: pointer;
    transition: all var(--transition);
    text-decoration: none;
}
.page-btn:hover { background: var(--bg-hover); border-color: var(--border-strong); color: var(--text-primary); }
.page-btn.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); font-weight: 600; }
.page-btn.disabled { opacity: .35; pointer-events: none; }

/* ── Boutons ── */
.btn-primary {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--accent);
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13.5px;
    border-radius: var(--radius-md);
    padding: 10px 20px;
    border: none;
    cursor: pointer;
    text-decoration: none;
    transition: opacity .18s;
    min-height: 44px;
}
.btn-primary:hover { opacity: .88; }

.btn-ghost {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 13px;
    border-radius: var(--radius-sm);
    padding: 8px 16px;
    text-decoration: none;
    transition: all var(--transition);
    min-height: 44px;
}
.btn-ghost:hover { background: var(--bg-hover); border-color: var(--border-strong); color: var(--text-primary); }

.btn-accent-sm {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--accent);
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 13px;
    border-radius: var(--radius-sm);
    padding: 8px 16px;
    border: none;
    cursor: pointer;
    min-height: 44px;
}

/* ── Animation ── */
.fade-in { animation: fadeIn .35s ease both; }
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
}
{% endblock %}

{% block content %}

<!-- En-tête de page -->
<div class="page-header fade-in">
    <div>
        <div style="font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);font-weight:600;">Opérations / Achats</div>
        <h1 style="font-family:'Syne',sans-serif;font-size:clamp(18px,4vw,24px);font-weight:800;letter-spacing:-.025em;color:var(--text-primary);margin-top:2px;">Commandes d'achat</h1>
    </div>
    {% if request.user.userprofile %}
    {% if request.user.userprofile.is_finance or request.user.userprofile.is_manager %}
    <a href="{% url 'purchases:create' %}" class="btn-primary">
        <i class="bi bi-plus-lg"></i> Nouvel achat
    </a>
    {% endif %}
    {% endif %}
</div>

<!-- Filtres -->
<div class="filter-card fade-in">
    <form method="get">
        <div class="filter-row">
            <div class="filter-group">
                <label>Rechercher</label>
                <div class="filter-input-wrap">
                    <i class="bi bi-search"></i>
                    <input type="text" name="search" value="{{ search_form.search.value|default:'' }}"
                           placeholder="Fournisseur, n° déclaration…"
                           class="filter-input filter-input-icon">
                </div>
            </div>
            <div class="filter-group">
                <label>Fournisseur</label>
                <select name="supplier" class="filter-input">
                    <option value="">Tous les fournisseurs</option>
                    {% for sup in search_form.supplier.field.queryset %}
                    <option value="{{ sup.pk }}" {% if search_form.supplier.value|stringformat:"s" == sup.pk|stringformat:"s" %}selected{% endif %}>{{ sup.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="filter-group">
                <label>Du</label>
                <input type="date" name="date_from" value="{{ search_form.date_from.value|default:'' }}" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Au</label>
                <input type="date" name="date_to" value="{{ search_form.date_to.value|default:'' }}" class="filter-input">
            </div>
            <div class="filter-group">
                <label>Statut douanier</label>
                <select name="customs_status" class="filter-input">
                    <option value="">Tous</option>
                    <option value="pending" {% if search_form.customs_status.value == 'pending' %}selected{% endif %}>En attente</option>
                    <option value="cleared" {% if search_form.customs_status.value == 'cleared' %}selected{% endif %}>Dédouané</option>
                </select>
            </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
            <button type="submit" class="btn-accent-sm">
                <i class="bi bi-funnel"></i> Filtrer
            </button>
            <a href="{% url 'purchases:list' %}" class="btn-ghost">
                <i class="bi bi-x-lg"></i> Réinitialiser
            </a>
        </div>
    </form>
</div>

<!-- Tableau -->
<div class="table-card fade-in">
    <div class="table-card-head">
        <div>
            <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);">Toutes les commandes</div>
            <div style="font-size:11.5px;color:var(--text-muted);margin-top:1px;">{{ total_count }} enregistrement{{ total_count|pluralize }} trouvé{{ total_count|pluralize }}</div>
        </div>
    </div>

    {% if page_obj %}
    <div class="table-scroll">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Fournisseur</th>
                    <th style="text-align:right;">Prix FOB</th>
                    <th style="text-align:right;">Prix (DA)</th>
                    <th>Fret</th>
                    <th>Douanes</th>
                    <th style="text-align:right;"></th>
                </tr>
            </thead>
            <tbody>
                {% for purchase in page_obj %}
                <tr onclick="location.href='{% url 'purchases:detail' purchase.pk %}'">

                    <td style="white-space:nowrap;">
                        {{ purchase.purchase_date|date:"j M Y" }}
                    </td>

                    <td>
                        <div style="font-weight:500;color:var(--text-primary);">{{ purchase.supplier.name }}</div>
                        <div style="font-size:11px;color:var(--text-muted);margin-top:1px;">
                            <i class="bi bi-globe me-1"></i>{{ purchase.supplier.country }}
                        </div>
                    </td>

                    <td style="text-align:right;white-space:nowrap;">
                        <span style="color:var(--text-primary);font-weight:500;">{{ purchase.purchase_price_fob|floatformat:2 }}</span>
                        <span style="font-size:11px;color:var(--text-muted);margin-left:3px;">{{ purchase.currency.code }}</span>
                    </td>

                    <td style="text-align:right;white-space:nowrap;">
                        {% if purchase.purchase_price_da %}
                        <span style="font-family:'Syne',sans-serif;font-weight:700;color:var(--text-primary);">{{ purchase.purchase_price_da|floatformat:0 }}</span>
                        <span style="font-size:11px;color:var(--text-muted);margin-left:3px;">DA</span>
                        {% else %}—{% endif %}
                    </td>

                    <td>
                        {% with purchase.freight_cost as fc %}
                        {% if fc %}
                            <span class="pill pill-info"><i class="bi bi-check-circle"></i> {{ fc.get_freight_method_display }}</span>
                        {% else %}
                            <span class="pill pill-neutral"><i class="bi bi-dash"></i> Aucun</span>
                        {% endif %}
                        {% endwith %}
                    </td>

                    <td>
                        {% with purchase.customs_declaration as cd %}
                        {% if cd and cd.is_cleared %}
                            <span class="pill pill-success"><i class="bi bi-check-circle"></i> Dédouané</span>
                        {% elif cd %}
                            <span class="pill pill-warning"><i class="bi bi-hourglass-split"></i> En attente</span>
                        {% else %}
                            <span class="pill pill-neutral"><i class="bi bi-dash"></i> Aucune</span>
                        {% endif %}
                        {% endwith %}
                    </td>

                    <td style="text-align:right;">
                        <i class="bi bi-chevron-right" style="color:var(--text-muted);"></i>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-bar">
        <span>Page {{ page_obj.number }} sur {{ page_obj.paginator.num_pages }}&nbsp;·&nbsp;{{ total_count }} au total</span>
        <div class="page-btns">
            {% if page_obj.has_previous %}
            <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-btn"><i class="bi bi-chevron-left"></i></a>
            {% else %}
            <span class="page-btn disabled"><i class="bi bi-chevron-left"></i></span>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <span class="page-btn active">{{ num }}</span>
                {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                <a href="?page={{ num }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-btn">{{ num }}</a>
                {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}" class="page-btn"><i class="bi bi-chevron-right"></i></a>
            {% else %}
            <span class="page-btn disabled"><i class="bi bi-chevron-right"></i></span>
            {% endif %}
        </div>
    </div>

    {% else %}
    <!-- État vide -->
    <div style="text-align:center;padding:56px 20px;color:var(--text-muted);">
        <i class="bi bi-truck" style="font-size:36px;display:block;margin-bottom:14px;color:var(--border-strong);"></i>
        <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;color:var(--text-secondary);margin-bottom:6px;">Aucune commande trouvée</div>
        <div style="font-size:13px;">
            {% if request.GET.search %}Essayez d'ajuster vos filtres.{% else %}Créez votre premier achat pour commencer.{% endif %}
        </div>
        {% if request.user.userprofile %}
        {% if request.user.userprofile.is_finance or request.user.userprofile.is_manager %}
        <a href="{% url 'purchases:create' %}" class="btn-primary" style="margin-top:18px;">
            <i class="bi bi-plus-lg"></i> Créer le premier achat
        </a>
        {% endif %}
        {% endif %}
    </div>
    {% endif %}
</div>

{% endblock %}