{% extends "base.html" %}

{% block title %}{% if tier %}Modifier le palier{% else %}Nouveau palier{% endif %}{% endblock %}
{% block nav_commissions %}active{% endblock %}

{% block page_title %}{% if tier %}Modifier le palier{% else %}Nouveau palier{% endif %}{% endblock %}
{% block page_sub_text %}Configuration du palier de commission{% endblock %}

{% block extra_css %}
.form-card {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: var(--radius-lg);
    padding: 28px;
    max-width: 620px;
    box-shadow: var(--shadow-sm);
}
.form-section-title {
    font-family: 'Syne', sans-serif;
    font-size: 13px;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--border);
}
.field-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    letter-spacing: .04em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 7px;
}
.field-input {
    width: 100%;
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 11px 14px;
    min-height: 44px;
    transition: border-color var(--transition), box-shadow var(--transition);
}
.field-input:focus {
    outline: none;
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
}
.field-input.error { border-color: rgba(220,38,38,.5); }
.field-error {
    font-size: 12px;
    color: #dc2626;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 4px;
}
.field-help {
    font-size: 12px;
    color: var(--text-muted);
    margin-top: 5px;
}
.check-label {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    padding: 13px 14px;
    min-height: 44px;
    background: var(--bg-raised);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    transition: border-color var(--transition);
}
.check-label:hover { border-color: var(--border-strong); }
.check-label input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; flex-shrink: 0; }
.btn-primary {
    background: var(--accent);
    color: #fff;
    font-family: 'Syne', sans-serif;
    font-weight: 700;
    font-size: 14px;
    padding: 12px 28px;
    min-height: 44px;
    border-radius: var(--radius-md);
    border: none;
    cursor: pointer;
    transition: opacity var(--transition), transform .12s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
}
.btn-primary:hover { opacity: .88; }
.btn-primary:active { transform: scale(.99); }
.btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    font-family: 'Syne', sans-serif;
    font-weight: 600;
    font-size: 14px;
    padding: 11px 22px;
    min-height: 44px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    text-decoration: none;
}
.btn-ghost:hover {
    background: var(--bg-hover);
    border-color: var(--border-strong);
    color: var(--text-primary);
}
{% endblock %}

{% block content %}

<div style="margin-bottom:20px;">
    <a href="{% url 'commissions:tiers' %}" class="section-link">
        <i class="bi bi-arrow-left me-1"></i> Retour aux paliers de commission
    </a>
</div>

<div class="form-card">

    <div style="margin-bottom:24px;">
        <div style="font-size:10.5px;letter-spacing:.1em;text-transform:uppercase;color:var(--text-muted);font-weight:600;margin-bottom:4px;">
            {% if tier %}Modification{% else %}Création{% endif %}
        </div>
        <h1 style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;letter-spacing:-.025em;color:var(--text-primary);margin:0;">
            {% if tier %}{{ tier.name }}{% else %}Nouveau Palier de Commission{% endif %}
        </h1>
        {% if tier %}
        <div style="margin-top:8px;">
            {% if tier.is_active %}
                <span class="pill pill-success"><i class="bi bi-circle-fill" style="font-size:7px;"></i> Actif</span>
            {% else %}
                <span class="pill pill-neutral">Inactif</span>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
        <div style="background:rgba(220,38,38,.07);border:1px solid rgba(220,38,38,.2);border-radius:var(--radius-md);padding:12px 16px;margin-bottom:20px;font-size:13px;color:#dc2626;">
            <i class="bi bi-exclamation-circle me-2"></i>
            {% for error in form.non_field_errors %}{{ error }}{% endfor %}
        </div>
        {% endif %}

        <!-- Nom du palier -->
        <div style="margin-bottom:18px;">
            <label class="field-label" for="{{ form.name.id_for_label }}">Nom du palier</label>
            <input type="text"
                   id="{{ form.name.id_for_label }}"
                   name="{{ form.name.html_name }}"
                   value="{{ form.name.value|default:'' }}"
                   class="field-input {% if form.name.errors %}error{% endif %}"
                   placeholder="ex. Argent, Or, Platine">
            {% if form.name.errors %}
            <div class="field-error"><i class="bi bi-exclamation-circle"></i> {{ form.name.errors.0 }}</div>
            {% endif %}
        </div>

        <!-- Plage de ventes -->
        <div class="form-section-title" style="margin-top:24px;">Plage de ventes</div>
        <div class="row g-3 mb-4">
            <div class="col-sm-6">
                <label class="field-label" for="{{ form.min_sales_count.id_for_label }}">Ventes minimum</label>
                <input type="number"
                       id="{{ form.min_sales_count.id_for_label }}"
                       name="{{ form.min_sales_count.html_name }}"
                       value="{{ form.min_sales_count.value|default:'' }}"
                       class="field-input {% if form.min_sales_count.errors %}error{% endif %}"
                       min="0" placeholder="0">
                {% if form.min_sales_count.errors %}
                <div class="field-error"><i class="bi bi-exclamation-circle"></i> {{ form.min_sales_count.errors.0 }}</div>
                {% endif %}
            </div>
            <div class="col-sm-6">
                <label class="field-label" for="{{ form.max_sales_count.id_for_label }}">Ventes maximum</label>
                <input type="number"
                       id="{{ form.max_sales_count.id_for_label }}"
                       name="{{ form.max_sales_count.html_name }}"
                       value="{{ form.max_sales_count.value|default:'' }}"
                       class="field-input {% if form.max_sales_count.errors %}error{% endif %}"
                       min="0" placeholder="Laisser vide pour illimité">
                <div class="field-help">Laisser vide pour ne pas fixer de limite supérieure</div>
                {% if form.max_sales_count.errors %}
                <div class="field-error"><i class="bi bi-exclamation-circle"></i> {{ form.max_sales_count.errors.0 }}</div>
                {% endif %}
            </div>
        </div>

        <!-- Taux de commission -->
        <div class="form-section-title">Taux de commission</div>
        <div style="margin-bottom:20px;">
            <label class="field-label" for="{{ form.commission_rate.id_for_label }}">Taux (%)</label>
            <div style="position:relative;">
                <input type="number"
                       id="{{ form.commission_rate.id_for_label }}"
                       name="{{ form.commission_rate.html_name }}"
                       value="{{ form.commission_rate.value|default:'' }}"
                       step="0.01" min="0" max="100"
                       class="field-input {% if form.commission_rate.errors %}error{% endif %}"
                       placeholder="ex. 12.50"
                       style="padding-right:40px;">
                <span style="position:absolute;right:14px;top:50%;transform:translateY(-50%);font-size:16px;font-family:'Syne',sans-serif;font-weight:800;color:var(--accent);">%</span>
            </div>
            {% if form.commission_rate.errors %}
            <div class="field-error"><i class="bi bi-exclamation-circle"></i> {{ form.commission_rate.errors.0 }}</div>
            {% endif %}
            <div class="field-help">Pourcentage de la marge versé en commission (0–100)</div>
        </div>

        <!-- Palier actif -->
        <div style="margin-bottom:28px;">
            <label class="check-label">
                <input type="checkbox"
                       id="{{ form.is_active.id_for_label }}"
                       name="{{ form.is_active.html_name }}"
                       {% if form.is_active.value %}checked{% endif %}>
                <div>
                    <div style="font-size:14px;font-weight:500;color:var(--text-primary);">Palier actif</div>
                    <div style="font-size:12px;color:var(--text-muted);margin-top:1px;">Les paliers inactifs sont exclus des calculs de commission</div>
                </div>
            </label>
        </div>

        <!-- Actions -->
        <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
            <button type="submit" class="btn-primary">
                <i class="bi bi-check-lg"></i>
                {% if tier %}Enregistrer les modifications{% else %}Créer le palier{% endif %}
            </button>
            <a href="{% url 'commissions:tiers' %}" class="btn-ghost">Annuler</a>
        </div>

    </form>
</div>

{% endblock %}