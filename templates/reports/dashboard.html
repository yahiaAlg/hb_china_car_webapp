{% extends "base.html" %}
{% block title %}Rapports{% endblock %}
{% block nav_reports %}active{% endblock %}
{% block page_title %}Rapports{% endblock %}
{% block page_sub_text %}Vue d'ensemble &amp; indicateurs clés du mois en cours{% endblock %}

{% block extra_css %}
.chart-panel{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow-sm);}
.cp-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:3px;}
.cp-sub{font-size:12px;color:var(--text-muted);margin-bottom:14px;}
.btn-ghost-sm{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:'Syne',sans-serif;font-weight:600;font-size:12px;padding:7px 14px;border-radius:var(--radius-md);cursor:pointer;transition:all var(--transition);display:inline-flex;align-items:center;gap:6px;text-decoration:none;min-height:40px;}
.btn-ghost-sm:hover{background:var(--bg-hover);border-color:var(--border-strong);color:var(--text-primary);}
.module-card{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow-sm);transition:box-shadow .2s,border-color .2s;text-decoration:none;display:block;}
.module-card:hover{box-shadow:var(--shadow-md);border-color:var(--border-strong);}
.module-icon{width:44px;height:44px;border-radius:var(--radius-md);display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:12px;}
.rank-badge{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;font-family:'Syne',sans-serif;font-size:11px;font-weight:800;flex-shrink:0;}
.section-head{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);}
.section-sub{font-size:12px;color:var(--text-muted);}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;}
{% endblock %}

{% block content %}

<!-- KPIs -->
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-blue"><i class="bi bi-graph-up-arrow"></i></div>
      <div class="metric-label">CA mensuel</div>
      <div class="metric-value sm">{{ financial_stats.monthly_revenue|floatformat:0 }}</div>
      <span style="font-size:12px;color:var(--text-muted);">DA ce mois</span>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-amber"><i class="bi bi-piggy-bank"></i></div>
      <div class="metric-label">Marge mensuelle</div>
      <div class="metric-value sm">{{ financial_stats.monthly_margin|floatformat:0 }}</div>
      <span style="font-size:12px;color:var(--text-muted);">DA ce mois</span>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-green"><i class="bi bi-boxes"></i></div>
      <div class="metric-label">Véhicules disponibles</div>
      <div class="metric-value">{{ inventory_stats.available_vehicles }}</div>
      <span style="font-size:12px;color:var(--text-muted);">sur {{ inventory_stats.total_vehicles }} en stock</span>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-pink"><i class="bi bi-exclamation-circle"></i></div>
      <div class="metric-label">Impayés</div>
      <div class="metric-value">{{ financial_stats.outstanding_invoices }}</div>
      <span style="font-size:12px;color:#dc2626;font-weight:600;">{{ financial_stats.total_outstanding|floatformat:0 }} DA</span>
    </div>
  </div>
</div>

<!-- ═══ LIGNE 1 : Donut stock + Santé financière + Traders chart ═══ -->
<div class="row g-3 mb-4">

  <!-- Donut stock -->
  <div class="col-xl-4">
    <div class="chart-panel">
      <div class="cp-title">Stock par statut</div>
      <div class="cp-sub">Répartition en temps réel</div>
      <div style="height:200px;"><canvas id="stockDonut"></canvas></div>
      <div style="margin-top:14px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
        <div style="background:rgba(22,163,74,.08);border-radius:var(--radius-md);padding:10px;text-align:center;">
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#16a34a;">{{ inventory_stats.available_vehicles }}</div>
          <div style="font-size:10px;color:var(--text-muted);">Disponibles</div>
        </div>
        <div style="background:rgba(2,132,199,.08);border-radius:var(--radius-md);padding:10px;text-align:center;">
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#0284c7;">{{ inventory_stats.in_transit }}</div>
          <div style="font-size:10px;color:var(--text-muted);">En transit</div>
        </div>
        <div style="background:rgba(217,119,6,.08);border-radius:var(--radius-md);padding:10px;text-align:center;">
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#d97706;">{{ inventory_stats.at_customs }}</div>
          <div style="font-size:10px;color:var(--text-muted);">En douane</div>
        </div>
        <div style="background:rgba(124,58,237,.08);border-radius:var(--radius-md);padding:10px;text-align:center;">
          <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#7c3aed;">{{ inventory_stats.total_vehicles }}</div>
          <div style="font-size:10px;color:var(--text-muted);">Total stock</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Santé financière -->
  <div class="col-xl-4">
    <div class="chart-panel">
      <div class="cp-title">Santé financière du mois</div>
      <div class="cp-sub">CA · Marge · Impayés en un coup d'œil</div>
      <div style="height:200px;"><canvas id="finHealthChart"></canvas></div>
      <div style="margin-top:14px;padding:12px;background:var(--bg-raised);border-radius:var(--radius-md);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
          <span style="font-size:12px;color:var(--text-secondary);">Marge / CA ce mois</span>
          <span style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--accent);">
            {% if financial_stats.monthly_revenue > 0 %}{% widthratio financial_stats.monthly_margin financial_stats.monthly_revenue 100 %}%{% else %}—{% endif %}
          </span>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:12px;color:var(--text-secondary);">Factures en attente</span>
          <span style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:#dc2626;">{{ financial_stats.outstanding_invoices }} impayée{{ financial_stats.outstanding_invoices|pluralize }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Traders performance chart -->
  <div class="col-xl-4">
    <div class="chart-panel">
      <div class="cp-title">Performance traders — CA ce mois</div>
      <div class="cp-sub">Chiffre d'affaires &amp; commissions</div>
      <div style="height:270px;"><canvas id="tradersChart"></canvas></div>
    </div>
  </div>
</div>

<!-- ═══ TABLEAU : Classement traders ═══ -->
<div class="card mb-4">
  <div style="padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
    <div>
      <div class="section-head">Classement des traders — mois en cours</div>
      <div class="section-sub">Classés par chiffre d'affaires · commissions incluses</div>
    </div>
    <a href="{% url 'reports:profit_analysis' %}" class="btn-ghost-sm"><i class="bi bi-arrow-right"></i> Rapport complet</a>
  </div>
  <div class="table-scroll">
    {% if top_traders %}
    <table class="table-custom">
      <thead>
        <tr>
          <th>#</th>
          <th>Trader</th>
          <th>Nb. ventes</th>
          <th>Chiffre d'affaires</th>
          <th>Commission totale</th>
          <th>CA moy. / vente</th>
        </tr>
      </thead>
      <tbody>
        {% for t in top_traders %}
        <tr>
          <td>
            <span class="rank-badge" style="background:{% if forloop.counter == 1 %}rgba(217,119,6,.15);color:#d97706;{% elif forloop.counter == 2 %}rgba(107,114,128,.12);color:#374151;{% elif forloop.counter == 3 %}rgba(180,120,60,.12);color:#92400e;{% else %}rgba(0,0,0,.05);color:var(--text-muted);{% endif %}">{{ forloop.counter }}</span>
          </td>
          <td style="font-weight:600;color:var(--text-primary);">{{ t.assigned_trader__first_name }} {{ t.assigned_trader__last_name }}</td>
          <td>{{ t.sales_count }}</td>
          <td style="color:var(--accent);font-weight:500;white-space:nowrap;">{{ t.total_revenue|floatformat:0 }} DA</td>
          <td style="color:#7c3aed;white-space:nowrap;">{{ t.total_commission|floatformat:0 }} DA</td>
          <td style="color:var(--text-secondary);white-space:nowrap;">
            {% if t.sales_count > 0 %}{% widthratio t.total_revenue t.sales_count 1 %} DA{% else %}—{% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center;padding:36px 20px;color:var(--text-muted);">
      <i class="bi bi-people" style="font-size:28px;display:block;margin-bottom:10px;color:var(--border-strong);"></i>
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-secondary);margin-bottom:4px;">Aucune vente ce mois</div>
      <div style="font-size:12px;">Les données apparaîtront dès que des ventes seront enregistrées.</div>
    </div>
    {% endif %}
  </div>
</div>

<!-- ═══ TABLEAU : Dernières ventes ═══ -->
<div class="card mb-4">
  <div style="padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
    <div>
      <div class="section-head">Dernières ventes finalisées</div>
      <div class="section-sub">5 transactions les plus récentes</div>
    </div>
    <a href="{% url 'reports:sales_summary' %}" class="btn-ghost-sm"><i class="bi bi-arrow-right"></i> Voir tout</a>
  </div>
  <div class="table-scroll">
    {% if recent_sales %}
    <table class="table-custom">
      <thead>
        <tr>
          <th>Date</th>
          <th>Véhicule</th>
          <th>Client</th>
          <th>Trader</th>
          <th>Prix de vente</th>
          <th>Marge</th>
          <th>Commission</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in recent_sales %}
        <tr>
          <td style="color:var(--text-muted);white-space:nowrap;">{{ sale.sale_date|date:"j M Y" }}</td>
          <td style="font-weight:600;color:var(--text-primary);white-space:nowrap;">
            <i class="bi bi-car-front" style="color:var(--text-muted);margin-right:5px;"></i>{{ sale.vehicle.make }} {{ sale.vehicle.model }}
          </td>
          <td style="color:var(--text-secondary);">{{ sale.customer.name }}</td>
          <td style="color:var(--text-muted);">{{ sale.assigned_trader.get_full_name|default:sale.assigned_trader.username }}</td>
          <td style="color:var(--accent);font-weight:500;white-space:nowrap;">{{ sale.sale_price|floatformat:0 }} DA</td>
          <td style="color:#16a34a;font-weight:500;white-space:nowrap;">{{ sale.margin_amount|floatformat:0 }} DA</td>
          <td style="color:#7c3aed;white-space:nowrap;">{{ sale.commission_amount|floatformat:0|default:"—" }} DA</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div style="text-align:center;padding:36px 20px;color:var(--text-muted);">
      <i class="bi bi-receipt" style="font-size:28px;display:block;margin-bottom:10px;color:var(--border-strong);"></i>
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-secondary);margin-bottom:4px;">Aucune vente récente</div>
      <div style="font-size:12px;">Les transactions finalisées apparaîtront ici.</div>
    </div>
    {% endif %}
  </div>
</div>

<!-- ═══ LIGNE : Récap stock + Snapshot impayés ═══ -->
<div class="row g-3 mb-4">

  <!-- Stock tableau récap -->
  <div class="col-xl-6">
    <div class="card" style="height:100%;">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="section-head">Récapitulatif du stock</div>
          <div class="section-sub">Répartition par statut en temps réel</div>
        </div>
        <a href="{% url 'reports:inventory_status' %}" class="btn-ghost-sm"><i class="bi bi-arrow-right"></i> Détail</a>
      </div>
      <div class="table-scroll">
        <table class="table-custom">
          <thead><tr><th>Statut</th><th>Nb. véhicules</th><th>% du stock</th></tr></thead>
          <tbody>
            <tr>
              <td><span class="pill pill-success">Disponible</span></td>
              <td style="font-weight:600;color:var(--text-primary);">{{ inventory_stats.available_vehicles }}</td>
              <td>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;height:6px;background:var(--bg-raised);border-radius:3px;min-width:60px;overflow:hidden;"><div style="height:100%;background:#16a34a;border-radius:3px;width:{% if inventory_stats.total_vehicles > 0 %}{% widthratio inventory_stats.available_vehicles inventory_stats.total_vehicles 100 %}{% else %}0{% endif %}%;"></div></div>
                  <span style="font-size:12px;color:var(--text-muted);">{% if inventory_stats.total_vehicles > 0 %}{% widthratio inventory_stats.available_vehicles inventory_stats.total_vehicles 100 %}{% else %}0{% endif %}%</span>
                </div>
              </td>
            </tr>
            <tr>
              <td><span class="pill pill-info">En transit</span></td>
              <td style="font-weight:600;color:var(--text-primary);">{{ inventory_stats.in_transit }}</td>
              <td>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;height:6px;background:var(--bg-raised);border-radius:3px;min-width:60px;overflow:hidden;"><div style="height:100%;background:#0284c7;border-radius:3px;width:{% if inventory_stats.total_vehicles > 0 %}{% widthratio inventory_stats.in_transit inventory_stats.total_vehicles 100 %}{% else %}0{% endif %}%;"></div></div>
                  <span style="font-size:12px;color:var(--text-muted);">{% if inventory_stats.total_vehicles > 0 %}{% widthratio inventory_stats.in_transit inventory_stats.total_vehicles 100 %}{% else %}0{% endif %}%</span>
                </div>
              </td>
            </tr>
            <tr>
              <td><span class="pill pill-warning">En douane</span></td>
              <td style="font-weight:600;color:var(--text-primary);">{{ inventory_stats.at_customs }}</td>
              <td>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="flex:1;height:6px;background:var(--bg-raised);border-radius:3px;min-width:60px;overflow:hidden;"><div style="height:100%;background:#d97706;border-radius:3px;width:{% if inventory_stats.total_vehicles > 0 %}{% widthratio inventory_stats.at_customs inventory_stats.total_vehicles 100 %}{% else %}0{% endif %}%;"></div></div>
                  <span style="font-size:12px;color:var(--text-muted);">{% if inventory_stats.total_vehicles > 0 %}{% widthratio inventory_stats.at_customs inventory_stats.total_vehicles 100 %}{% else %}0{% endif %}%</span>
                </div>
              </td>
            </tr>
            <tr style="background:var(--bg-raised);">
              <td style="font-weight:700;color:var(--text-secondary);">TOTAL</td>
              <td style="font-weight:700;color:var(--text-primary);">{{ inventory_stats.total_vehicles }}</td>
              <td><span style="font-size:12px;color:var(--text-muted);">100%</span></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Impayés snapshot -->
  <div class="col-xl-6">
    <div class="card" style="height:100%;">
      <div style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;">
        <div>
          <div class="section-head">Snapshot des impayés</div>
          <div class="section-sub">Situation des encaissements en cours</div>
        </div>
        <a href="{% url 'reports:payment_status' %}" class="btn-ghost-sm"><i class="bi bi-arrow-right"></i> Détail</a>
      </div>
      <div style="padding:16px 20px;">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;">
          <div style="padding:14px;background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.15);border-radius:var(--radius-md);">
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:#dc2626;font-weight:600;margin-bottom:6px;">Factures impayées</div>
            <div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:#dc2626;">{{ financial_stats.outstanding_invoices }}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">facture{{ financial_stats.outstanding_invoices|pluralize }}</div>
          </div>
          <div style="padding:14px;background:rgba(220,38,38,.06);border:1px solid rgba(220,38,38,.15);border-radius:var(--radius-md);">
            <div style="font-size:10px;text-transform:uppercase;letter-spacing:.06em;color:#dc2626;font-weight:600;margin-bottom:6px;">Montant total dû</div>
            <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:#dc2626;">{{ financial_stats.total_outstanding|floatformat:0 }}</div>
            <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">DA</div>
          </div>
        </div>
        <!-- Rapport CA vs Marge vs Impayés -->
        <table style="width:100%;font-size:13px;border-collapse:collapse;">
          <thead>
            <tr style="border-bottom:1px solid var(--border);">
              <th style="text-align:left;padding:8px 0;font-size:10.5px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);font-weight:600;">Indicateur</th>
              <th style="text-align:right;padding:8px 0;font-size:10.5px;text-transform:uppercase;letter-spacing:.06em;color:var(--text-muted);font-weight:600;">Montant (DA)</th>
            </tr>
          </thead>
          <tbody>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:9px 0;color:var(--text-secondary);"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#0284c7;margin-right:8px;"></span>CA mensuel</td>
              <td style="padding:9px 0;text-align:right;font-family:'Syne',sans-serif;font-weight:700;color:#0284c7;">{{ financial_stats.monthly_revenue|floatformat:0 }}</td>
            </tr>
            <tr style="border-bottom:1px solid var(--border);">
              <td style="padding:9px 0;color:var(--text-secondary);"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#d97706;margin-right:8px;"></span>Marge mensuelle</td>
              <td style="padding:9px 0;text-align:right;font-family:'Syne',sans-serif;font-weight:700;color:#d97706;">{{ financial_stats.monthly_margin|floatformat:0 }}</td>
            </tr>
            <tr>
              <td style="padding:9px 0;color:var(--text-secondary);"><span style="display:inline-block;width:8px;height:8px;border-radius:2px;background:#dc2626;margin-right:8px;"></span>Solde impayé</td>
              <td style="padding:9px 0;text-align:right;font-family:'Syne',sans-serif;font-weight:700;color:#dc2626;">{{ financial_stats.total_outstanding|floatformat:0 }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ═══ MODULES ═══ -->
<div style="font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--text-secondary);letter-spacing:.05em;text-transform:uppercase;margin-bottom:12px;">Accès aux modules de rapport</div>
<div class="row g-3">
  <div class="col-sm-6 col-xl-3">
    <a href="{% url 'reports:profit_analysis' %}" class="module-card">
      <div class="module-icon" style="background:rgba(217,119,6,.12);color:#d97706;"><i class="bi bi-bar-chart-line-fill"></i></div>
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Analyse de rentabilité</div>
      <div style="font-size:12px;color:var(--text-muted);">Marges, CA et décomposition du profit par période ou trader.</div>
    </a>
  </div>
  <div class="col-sm-6 col-xl-3">
    <a href="{% url 'reports:sales_summary' %}" class="module-card">
      <div class="module-icon" style="background:rgba(2,132,199,.12);color:#0284c7;"><i class="bi bi-receipt-cutoff"></i></div>
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Récapitulatif des ventes</div>
      <div style="font-size:12px;color:var(--text-muted);">Tendances, volumes et classement clients par mode de paiement.</div>
    </a>
  </div>
  <div class="col-sm-6 col-xl-3">
    <a href="{% url 'reports:inventory_status' %}" class="module-card">
      <div class="module-icon" style="background:rgba(22,163,74,.12);color:#16a34a;"><i class="bi bi-boxes"></i></div>
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:4px;">État du stock</div>
      <div style="font-size:12px;color:var(--text-muted);">Valorisation, ancienneté et analyse des invendus par fournisseur.</div>
    </a>
  </div>
  <div class="col-sm-6 col-xl-3">
    <a href="{% url 'reports:payment_status' %}" class="module-card">
      <div class="module-icon" style="background:rgba(220,38,38,.10);color:#dc2626;"><i class="bi bi-cash-coin"></i></div>
      <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:4px;">Statut des paiements</div>
      <div style="font-size:12px;color:var(--text-muted);">Taux d'encaissement, impayés et retards par tranche d'âge.</div>
    </a>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function p(s){return parseFloat(String(s).replace(/[\u00a0\u0020]/g,"").replace(",","."))||0;}
const ttCfg={backgroundColor:'#ffffff',borderColor:'rgba(0,0,0,.10)',borderWidth:1,titleColor:'#111827',bodyColor:'#6b7280',padding:10,cornerRadius:8};

new Chart(document.getElementById('stockDonut').getContext('2d'),{type:'doughnut',data:{labels:['Disponible','En transit','En douane','Autres'],datasets:[{data:[p("{{ inventory_stats.available_vehicles }}"),p("{{ inventory_stats.in_transit }}"),p("{{ inventory_stats.at_customs }}"),Math.max(0,p("{{ inventory_stats.total_vehicles }}")-p("{{ inventory_stats.available_vehicles }}")-p("{{ inventory_stats.in_transit }}")-p("{{ inventory_stats.at_customs }}"))],backgroundColor:['rgba(22,163,74,.20)','rgba(2,132,199,.20)','rgba(217,119,6,.20)','rgba(124,58,237,.15)'],borderColor:['#16a34a','#0284c7','#d97706','#7c3aed'],borderWidth:2,hoverOffset:4}]},options:{cutout:'70%',responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'bottom',labels:{color:'#9ca3af',font:{size:10.5},padding:8,boxWidth:10,boxHeight:10}},tooltip:ttCfg}}});

new Chart(document.getElementById('finHealthChart').getContext('2d'),{type:'bar',data:{labels:['CA mensuel','Marge mensuelle','Impayés'],datasets:[{data:[p("{{ financial_stats.monthly_revenue|floatformat:2 }}"),p("{{ financial_stats.monthly_margin|floatformat:2 }}"),p("{{ financial_stats.total_outstanding|floatformat:2 }}")],backgroundColor:['rgba(2,132,199,.18)','rgba(217,119,6,.20)','rgba(220,38,38,.18)'],borderColor:['#0284c7','#d97706','#dc2626'],borderWidth:1.5,borderRadius:8,borderSkipped:false}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},tooltip:{...ttCfg,callbacks:{label:c=>' '+Number(c.parsed.y).toLocaleString('fr-FR')+' DA'}}},scales:{x:{grid:{display:false},ticks:{color:'#9ca3af',font:{size:10.5}}},y:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9ca3af',font:{size:10.5},callback:v=>(v/1000000).toFixed(1)+'M'}}}}});

const traderNames=[{% for t in top_traders %}"{{ t.assigned_trader__first_name }} {{ t.assigned_trader__last_name }}"{% if not forloop.last %},{% endif %}{% endfor %}];
const traderRevs=[{% for t in top_traders %}p("{{ t.total_revenue|floatformat:2 }}"){% if not forloop.last %},{% endif %}{% endfor %}];
const traderComms=[{% for t in top_traders %}p("{{ t.total_commission|floatformat:2 }}"){% if not forloop.last %},{% endif %}{% endfor %}];
new Chart(document.getElementById('tradersChart').getContext('2d'),{type:'bar',data:{labels:traderNames,datasets:[{label:'CA (DA)',data:traderRevs,backgroundColor:'rgba(2,132,199,.16)',borderColor:'#0284c7',borderWidth:1.5,borderRadius:5,borderSkipped:false},{label:'Commissions (DA)',data:traderComms,backgroundColor:'rgba(217,119,6,.18)',borderColor:'#d97706',borderWidth:1.5,borderRadius:5,borderSkipped:false}]},options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},plugins:{legend:{labels:{color:'#9ca3af',font:{size:11},boxWidth:12}},tooltip:{...ttCfg,callbacks:{label:c=>' '+Number(c.parsed.x).toLocaleString('fr-FR')+' DA'}}},scales:{x:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9ca3af',font:{size:10.5},callback:v=>(v/1000000).toFixed(1)+'M'}},y:{grid:{display:false},ticks:{color:'#6b7280',font:{size:10.5}}}}}});
</script>
{% endblock %}