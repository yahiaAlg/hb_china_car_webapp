{% extends "base.html" %}
{% block title %}Analyse de rentabilit√©{% endblock %}
{% block nav_reports %}active{% endblock %}
{% block page_title %}Analyse de rentabilit√©{% endblock %}
{% block page_sub_text %}D√©composition des marges et du chiffre d'affaires{% endblock %}

{% block extra_css %}
.filter-bar{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:16px 20px;margin-bottom:20px;box-shadow:var(--shadow-sm);}
.filter-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(165px,1fr));gap:12px;align-items:end;}
.filter-group{display:flex;flex-direction:column;gap:5px;}
.filter-label{font-size:10.5px;font-weight:600;letter-spacing:.07em;text-transform:uppercase;color:var(--text-muted);}
.filter-input{background:var(--bg-raised);border:1px solid var(--border);border-radius:var(--radius-md);color:var(--text-primary);font-family:'DM Sans',sans-serif;font-size:13px;padding:9px 12px;width:100%;min-height:44px;}
.filter-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow);}
.filter-input option{background:var(--bg-raised);}
.btn-primary-sm{background:var(--accent);color:#fff;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;padding:9px 18px;border-radius:var(--radius-md);border:none;cursor:pointer;display:inline-flex;align-items:center;gap:6px;min-height:44px;}
.btn-primary-sm:hover{opacity:.88;}
.btn-ghost-sm{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:'Syne',sans-serif;font-weight:600;font-size:13px;padding:8px 16px;border-radius:var(--radius-md);cursor:pointer;display:inline-flex;align-items:center;gap:6px;text-decoration:none;min-height:44px;}
.btn-ghost-sm:hover{background:var(--bg-hover);border-color:var(--border-strong);color:var(--text-primary);}
.chart-panel{background:var(--bg-surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:20px;box-shadow:var(--shadow-sm);}
.cp-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);margin-bottom:3px;}
.cp-sub{font-size:12px;color:var(--text-muted);margin-bottom:14px;}
.funnel-row{display:flex;align-items:center;gap:10px;margin-bottom:10px;}
.funnel-lbl{font-size:11.5px;color:var(--text-secondary);width:95px;flex-shrink:0;}
.funnel-track{flex:1;height:26px;background:var(--bg-raised);border-radius:5px;overflow:hidden;}
.funnel-fill{height:100%;border-radius:5px;display:flex;align-items:center;padding-left:8px;transition:width .6s ease;}
.funnel-pct{font-size:10.5px;font-weight:700;}
.funnel-val{width:110px;text-align:right;font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;flex-shrink:0;}
.table-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.section-head{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--text-primary);}
.section-sub{font-size:12px;color:var(--text-muted);}
@media(max-width:768px){.filter-grid{grid-template-columns:1fr 1fr;}}
@media(max-width:480px){.filter-grid{grid-template-columns:1fr;}}
{% endblock %}

{% block content %}
<!-- Header row -->
<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
  <a href="{% url 'reports:dashboard' %}" style="font-size:13px;color:var(--text-muted);display:inline-flex;align-items:center;gap:5px;" onmouseover="this.style.color='var(--text-secondary)';" onmouseout="this.style.color='var(--text-muted)';">
    <i class="bi bi-arrow-left"></i> Tableau des rapports
  </a>
  {% if request.user.userprofile %}{% if request.user.userprofile.is_manager %}
  <a href="{% url 'reports:export_report' %}" class="btn-ghost-sm"><i class="bi bi-download"></i> Exporter</a>
  {% endif %}{% endif %}
</div>

<!-- KPIs -->
<div class="row g-3 mb-4">
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-green"><i class="bi bi-receipt"></i></div>
      <div class="metric-label">Total des ventes</div>
      <div class="metric-value">{{ total_sales }}</div>
      <span style="font-size:12px;color:var(--text-muted);">transactions</span>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-blue"><i class="bi bi-graph-up-arrow"></i></div>
      <div class="metric-label">Chiffre d'affaires</div>
      <div class="metric-value sm">{{ total_revenue|floatformat:0 }}</div>
      <span style="font-size:12px;color:var(--text-muted);">DA</span>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-amber"><i class="bi bi-piggy-bank"></i></div>
      <div class="metric-label">Marge totale</div>
      <div class="metric-value sm">{{ total_margin|floatformat:0 }}</div>
      <span class="metric-delta {% if margin_percentage > 15 %}up{% elif margin_percentage > 8 %}neutral{% else %}down{% endif %}">{{ margin_percentage|floatformat:1 }}%</span>
    </div>
  </div>
  <div class="col-sm-6 col-xl-3">
    <div class="metric-card">
      <div class="metric-icon ic-pink"><i class="bi bi-percent"></i></div>
      <div class="metric-label">B√©n√©fice net</div>
      <div class="metric-value sm">{{ net_profit|floatformat:0 }}</div>
      <span style="font-size:12px;color:var(--text-muted);">DA apr√®s commissions</span>
    </div>
  </div>
</div>

<!-- Filtres -->
<div class="filter-bar">
  <form method="get">
    <div class="filter-grid">
      <div class="filter-group"><label class="filter-label">Du</label><input type="date" name="date_from" class="filter-input" value="{{ form.date_from.value|default:'' }}"></div>
      <div class="filter-group"><label class="filter-label">Au</label><input type="date" name="date_to" class="filter-input" value="{{ form.date_to.value|default:'' }}"></div>
      {% if request.user.userprofile %}{% if not request.user.userprofile.is_trader %}
      <div class="filter-group">
        <label class="filter-label">Trader</label>
        <select name="trader" class="filter-input">
          <option value="">Tous les traders</option>
          {% for c in form.trader.field.queryset %}<option value="{{ c.pk }}" {% if form.trader.value == c.pk|stringformat:"s" %}selected{% endif %}>{{ c.get_full_name|default:c.username }}</option>{% endfor %}
        </select>
      </div>
      {% endif %}{% endif %}
      <div class="filter-group"><label class="filter-label">Marque v√©hicule</label><input type="text" name="vehicle_make" class="filter-input" placeholder="ex. Toyota" value="{{ form.vehicle_make.value|default:'' }}"></div>
      <div class="filter-group"><label class="filter-label">Marge min (DA)</label><input type="number" name="min_margin" class="filter-input" placeholder="0" value="{{ form.min_margin.value|default:'' }}"></div>
      <div class="filter-group">
        <label class="filter-label">Regrouper par</label>
        <select name="group_by" class="filter-input">
          <option value="month" {% if form.group_by.value == 'month' %}selected{% endif %}>Par mois</option>
          <option value="trader" {% if form.group_by.value == 'trader' %}selected{% endif %}>Par trader</option>
          <option value="customer" {% if form.group_by.value == 'customer' %}selected{% endif %}>Par client</option>
          <option value="vehicle_make" {% if form.group_by.value == 'vehicle_make' %}selected{% endif %}>Par marque</option>
        </select>
      </div>
      <div class="filter-group"><label class="filter-label">&nbsp;</label>
        <div style="display:flex;gap:8px;">
          <button type="submit" class="btn-primary-sm"><i class="bi bi-funnel"></i> Filtrer</button>
          <a href="{% url 'reports:profit_analysis' %}" class="btn-ghost-sm"><i class="bi bi-x"></i></a>
        </div>
      </div>
    </div>
  </form>
</div>

{% if grouped_data %}
<!-- ‚ïê‚ïê‚ïê GRAPHIQUES ‚ïê‚ïê‚ïê -->
<!-- Ligne 1 : CA & Marge + Entonnoir financier -->
<div class="row g-3 mb-4">
  <div class="col-xl-8">
    <div class="chart-panel">
      <div class="cp-title">CA &amp; Marge par p√©riode</div>
      <div class="cp-sub">Barres = chiffre d'affaires ¬∑ Ligne = marge brute</div>
      <div style="height:240px;"><canvas id="profitChart"></canvas></div>
    </div>
  </div>
  <div class="col-xl-4">
    <div class="chart-panel" style="height:100%;">
      <div class="cp-title">Entonnoir financier</div>
      <div class="cp-sub">Du CA brut au b√©n√©fice net</div>
      <div class="funnel-row">
        <div class="funnel-lbl">CA brut</div>
        <div class="funnel-track"><div class="funnel-fill" style="width:100%;background:rgba(2,132,199,.18);border:1px solid rgba(2,132,199,.3);"><span class="funnel-pct" style="color:#0284c7;">100%</span></div></div>
        <div class="funnel-val" style="color:#0284c7;">{{ total_revenue|floatformat:0 }} DA</div>
      </div>
      <div class="funnel-row">
        <div class="funnel-lbl">Marge brute</div>
        <div class="funnel-track"><div class="funnel-fill" id="fBar1" style="background:rgba(217,119,6,.18);border:1px solid rgba(217,119,6,.3);"><span class="funnel-pct" style="color:#d97706;">{{ margin_percentage|floatformat:1 }}%</span></div></div>
        <div class="funnel-val" style="color:#d97706;">{{ total_margin|floatformat:0 }} DA</div>
      </div>
      <div class="funnel-row">
        <div class="funnel-lbl">Commissions</div>
        <div class="funnel-track"><div class="funnel-fill" id="fBar2" style="background:rgba(124,58,237,.12);border:1px solid rgba(124,58,237,.2);"><span class="funnel-pct" id="fPct2" style="color:#7c3aed;"></span></div></div>
        <div class="funnel-val" style="color:#7c3aed;">{{ total_commission|floatformat:0 }} DA</div>
      </div>
      <div class="funnel-row">
        <div class="funnel-lbl">B√©n√©fice net</div>
        <div class="funnel-track"><div class="funnel-fill" id="fBar3" style="background:rgba(22,163,74,.18);border:1px solid rgba(22,163,74,.3);"><span class="funnel-pct" id="fPct3" style="color:#16a34a;"></span></div></div>
        <div class="funnel-val" style="color:#16a34a;">{{ net_profit|floatformat:0 }} DA</div>
      </div>
      <div style="margin-top:18px;padding:14px;background:var(--bg-raised);border-radius:var(--radius-md);text-align:center;">
        <div style="font-size:10px;text-transform:uppercase;letter-spacing:.07em;color:var(--text-muted);font-weight:600;margin-bottom:4px;">Taux de marge nette</div>
        <div style="font-family:'Syne',sans-serif;font-size:30px;font-weight:800;color:{% if margin_percentage > 15 %}#16a34a{% elif margin_percentage > 8 %}#d97706{% else %}#dc2626{% endif %};">{{ margin_percentage|floatformat:1 }}%</div>
        <div style="font-size:11px;color:var(--text-muted);margin-top:2px;">sur {{ total_sales }} transaction{{ total_sales|pluralize }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Ligne 2 : Taux marge par groupe + Top v√©hicules par marge -->
<div class="row g-3 mb-4">
  <div class="col-xl-6">
    <div class="chart-panel">
      <div class="cp-title">Taux de marge (%) par groupe</div>
      <div class="cp-sub">Vert ‚â• 15% ¬∑ Ambre 8‚Äì15% ¬∑ Rouge &lt; 8%</div>
      <div style="height:230px;"><canvas id="marginPctChart"></canvas></div>
    </div>
  </div>
  <div class="col-xl-6">
    <div class="chart-panel">
      <div class="cp-title">Meilleures marques ‚Äî marge cumul√©e</div>
      <div class="cp-sub">Top 8 mod√®les sur la p√©riode s√©lectionn√©e</div>
      <div style="height:230px;"><canvas id="vehicleMarginChart"></canvas></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TABLEAU GROUP√â (donn√©es de regroupement compl√®tes) ‚ïê‚ïê‚ïê -->
<div class="card mb-4">
  <div style="padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
    <div>
      <div class="section-head">D√©composition des marges</div>
      <div class="section-sub">Regroup√© par {{ form.group_by.value|default:"mois" }} ¬∑ {{ grouped_data|length }} groupe{{ grouped_data|length|pluralize }}</div>
    </div>
  </div>
  <div class="table-scroll">
    <table class="table-custom">
      <thead>
        <tr>
          <th>Groupe</th>
          <th>Nb. ventes</th>
          <th>Chiffre d'affaires</th>
          <th>Marge brute</th>
          <th>Taux de marge</th>
          <th>Commission</th>
        </tr>
      </thead>
      <tbody>
        {% for row in grouped_data %}
        <tr>
          <td style="font-weight:600;color:var(--text-primary);">{{ row.label }}</td>
          <td>{{ row.sales_count }}</td>
          <td style="color:var(--accent);font-weight:500;">{{ row.revenue|floatformat:0 }} DA</td>
          <td style="color:#16a34a;font-weight:500;">{{ row.margin|floatformat:0 }} DA</td>
          <td>
            <span class="pill {% if row.margin_percentage > 15 %}pill-success{% elif row.margin_percentage > 8 %}pill-warning{% else %}pill-danger{% endif %}">
              {{ row.margin_percentage|floatformat:1 }}%
            </span>
          </td>
          <td style="color:#7c3aed;">{{ row.commission|floatformat:0 }} DA</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr style="background:var(--bg-raised);font-weight:700;">
          <td style="color:var(--text-secondary);">TOTAL</td>
          <td style="color:var(--text-primary);">{{ total_sales }}</td>
          <td style="color:var(--accent);">{{ total_revenue|floatformat:0 }} DA</td>
          <td style="color:#16a34a;">{{ total_margin|floatformat:0 }} DA</td>
          <td>
            <span class="pill {% if margin_percentage > 15 %}pill-success{% elif margin_percentage > 8 %}pill-warning{% else %}pill-danger{% endif %}">
              {{ margin_percentage|floatformat:1 }}%
            </span>
          </td>
          <td style="color:#7c3aed;">{{ total_commission|floatformat:0 }} DA</td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TOP 10 V√âHICULES PAR MARGE ‚ïê‚ïê‚ïê -->
{% if top_vehicles %}
<div class="card mb-4">
  <div style="padding:16px 20px;border-bottom:1px solid var(--border);">
    <div class="section-head">Top 10 v√©hicules par marge</div>
    <div class="section-sub">Class√©s par marge brute cumul√©e</div>
  </div>
  <div class="table-scroll">
    <table class="table-custom">
      <thead>
        <tr>
          <th>#</th>
          <th>Marque / Mod√®le</th>
          <th>Nb. vendus</th>
          <th>CA total</th>
          <th>Marge totale</th>
          <th>Marge moy. / v√©h.</th>
        </tr>
      </thead>
      <tbody>
        {% for v in top_vehicles %}
        <tr>
          <td style="color:var(--text-muted);">{{ forloop.counter }}</td>
          <td style="font-weight:600;color:var(--text-primary);">
            <span style="margin-right:6px;">üöó</span>{{ v.vehicle }}
          </td>
          <td>{{ v.count }}</td>
          <td style="color:var(--accent);">{{ v.revenue|floatformat:0 }} DA</td>
          <td style="color:#16a34a;font-weight:500;">{{ v.margin|floatformat:0 }} DA</td>
          <td style="color:var(--text-secondary);">{{ v.avg_margin|floatformat:0 }} DA</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

<!-- ‚ïê‚ïê‚ïê D√âTAIL DES VENTES ‚ïê‚ïê‚ïê -->
{% if sales_list %}
<div class="card">
  <div style="padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);">
    <div>
      <div class="section-head">D√©tail des ventes</div>
      <div class="section-sub">20 premi√®res transactions correspondant aux filtres</div>
    </div>
    <div style="display:flex;align-items:center;gap:8px;">
      <span style="font-size:12px;color:var(--text-muted);">Prix moy. : <strong style="color:var(--text-primary);">{{ avg_sale_price|floatformat:0 }} DA</strong></span>
    </div>
  </div>
  <div class="table-scroll">
    <table class="table-custom">
      <thead>
        <tr>
          <th>Date</th>
          <th>V√©hicule</th>
          <th>Client</th>
          <th>Trader</th>
          <th>Prix de vente</th>
          <th>Marge</th>
          <th>Taux marge</th>
          <th>Commission</th>
        </tr>
      </thead>
      <tbody>
        {% for sale in sales_list %}
        <tr>
          <td style="color:var(--text-muted);white-space:nowrap;">{{ sale.sale_date|date:"j M Y" }}</td>
          <td style="font-weight:600;color:var(--text-primary);white-space:nowrap;">{{ sale.vehicle.make }} {{ sale.vehicle.model }}</td>
          <td>{{ sale.customer.name }}</td>
          <td style="color:var(--text-secondary);">{{ sale.assigned_trader.get_full_name|default:sale.assigned_trader.username }}</td>
          <td style="white-space:nowrap;">{{ sale.sale_price|floatformat:0 }} DA</td>
          <td style="color:#16a34a;font-weight:500;white-space:nowrap;">{{ sale.margin_amount|floatformat:0 }} DA</td>
          <td>
            <span class="pill {% if sale.margin_percentage > 15 %}pill-success{% elif sale.margin_percentage > 8 %}pill-warning{% else %}pill-danger{% endif %}">
              {{ sale.margin_percentage|floatformat:1 }}%
            </span>
          </td>
          <td style="color:#7c3aed;white-space:nowrap;">{{ sale.commission_amount|floatformat:0|default:"‚Äî" }} DA</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endif %}

{% else %}
<div class="chart-panel mb-4" style="text-align:center;padding:56px 20px;">
  <i class="bi bi-bar-chart-line" style="font-size:40px;color:var(--border-strong);display:block;margin-bottom:14px;"></i>
  <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--text-secondary);margin-bottom:6px;">Aucune donn√©e √† afficher</div>
  <div style="font-size:13px;color:var(--text-muted);">Appliquez des filtres et cliquez sur ¬´ Filtrer ¬ª pour g√©n√©rer le rapport.</div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function p(s){return parseFloat(String(s).replace(/[\u00a0\u0020]/g,"").replace(",","."))||0;}
const _rev  = p("{{ total_revenue|floatformat:2 }}");
const _mar  = p("{{ total_margin|floatformat:2 }}");
const _comm = p("{{ total_commission|floatformat:2 }}");
const _net  = p("{{ net_profit|floatformat:2 }}");
function fPct(v){return _rev>0?Math.max(5,v/_rev*100).toFixed(1):'5';}
(function(){
  const b1=document.getElementById('fBar1'); if(b1)b1.style.width=fPct(_mar)+'%';
  const b2=document.getElementById('fBar2'); if(b2)b2.style.width=fPct(_comm)+'%';
  const b3=document.getElementById('fBar3'); if(b3)b3.style.width=fPct(_net)+'%';
  const p2=document.getElementById('fPct2'); if(p2)p2.textContent=_rev>0?(_comm/_rev*100).toFixed(1)+'%':'0%';
  const p3=document.getElementById('fPct3'); if(p3)p3.textContent=_rev>0?(_net/_rev*100).toFixed(1)+'%':'0%';
})();

const ttCfg={backgroundColor:'#ffffff',borderColor:'rgba(0,0,0,.10)',borderWidth:1,titleColor:'#111827',bodyColor:'#6b7280',padding:10,cornerRadius:8};

{% if grouped_data %}
const _cd={{ chart_grouped_data|safe }};
const labels=_cd.labels, revenues=_cd.revenues, margins=_cd.margins;
const mpcts=[{% for r in grouped_data %}p("{{ r.margin_percentage|floatformat:2 }}"){% if not forloop.last %},{% endif %}{% endfor %}];

/* CA + Marge */
const ctx=document.getElementById('profitChart').getContext('2d');
const grad=ctx.createLinearGradient(0,0,0,240);
grad.addColorStop(0,'rgba(217,119,6,.22)');grad.addColorStop(1,'rgba(217,119,6,0)');
new Chart(ctx,{type:'bar',data:{labels,datasets:[
  {label:'CA (DA)',data:revenues,backgroundColor:'rgba(2,132,199,.14)',borderColor:'#0284c7',borderWidth:1.5,borderRadius:6,borderSkipped:false,order:2},
  {label:'Marge (DA)',data:margins,type:'line',borderColor:'#d97706',backgroundColor:grad,borderWidth:2.5,tension:.4,fill:true,pointBackgroundColor:'#d97706',pointRadius:4,pointHoverRadius:6,order:1}
]},options:{responsive:true,maintainAspectRatio:false,interaction:{mode:'index',intersect:false},
  plugins:{legend:{labels:{color:'#9ca3af',font:{size:11},boxWidth:12}},tooltip:{...ttCfg,callbacks:{label:c=>' '+Number(c.parsed.y).toLocaleString('fr-FR')+' DA'}}},
  scales:{x:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9ca3af',font:{size:10.5}}},y:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9ca3af',font:{size:10.5},callback:v=>(v/1000000).toFixed(1)+'M'}}}}});

/* Marge % - horizontal */
const pctCtx=document.getElementById('marginPctChart').getContext('2d');
new Chart(pctCtx,{type:'bar',data:{labels,datasets:[{label:'Taux de marge (%)',data:mpcts,
  backgroundColor:mpcts.map(v=>v>=15?'rgba(22,163,74,.20)':v>=8?'rgba(217,119,6,.20)':'rgba(220,38,38,.16)'),
  borderColor:mpcts.map(v=>v>=15?'#16a34a':v>=8?'#d97706':'#dc2626'),
  borderWidth:1.5,borderRadius:6,borderSkipped:false}]},
  options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
    plugins:{legend:{display:false},tooltip:{...ttCfg,callbacks:{label:c=>' '+c.parsed.x.toFixed(1)+'%'}}},
    scales:{x:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9ca3af',font:{size:10.5},callback:v=>v+'%'},max:Math.max(35,...mpcts)+3},y:{grid:{display:false},ticks:{color:'#6b7280',font:{size:10.5}}}}}});
{% endif %}

/* Top v√©hicules */
const vLbls=[{% for v in top_vehicles %}"{{ v.vehicle }}"{% if not forloop.last %},{% endif %}{% endfor %}];
const vMars=[{% for v in top_vehicles %}p("{{ v.margin|floatformat:2 }}"){% if not forloop.last %},{% endif %}{% endfor %}];
const pal=['#d97706','#0284c7','#16a34a','#7c3aed','#ea580c','#0d9488','#db2777','#4f46e5'];
(function(){
  const el=document.getElementById('vehicleMarginChart'); if(!el)return;
  new Chart(el.getContext('2d'),{type:'bar',data:{labels:vLbls,datasets:[{label:'Marge totale (DA)',data:vMars,
    backgroundColor:pal.map(c=>c+'22'),borderColor:pal,borderWidth:1.5,borderRadius:6,borderSkipped:false}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{...ttCfg,callbacks:{label:c=>' '+Number(c.parsed.x).toLocaleString('fr-FR')+' DA'}}},
      scales:{x:{grid:{color:'rgba(0,0,0,0.05)'},ticks:{color:'#9ca3af',font:{size:10.5},callback:v=>(v/1000000).toFixed(1)+'M'}},y:{grid:{display:false},ticks:{color:'#6b7280',font:{size:10.5}}}}}});
})();
</script>
{% endblock %}